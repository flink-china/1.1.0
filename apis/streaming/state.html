<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.1.0 中文文档: 状态管理</title>
    <link rel="shortcut icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/1.1.0/page/css/flink.css">
    <link rel="stylesheet" href="/1.1.0/page/css/syntax.css">
    <link rel="stylesheet" href="/1.1.0/page/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    
    <div style="position:fixed; bottom:0; left:0; z-index:99999; width:100%; text-align:center; padding:15px; border-top:1px dashed #CE4B65; background:#f6f0e3; font-weight:bold">
       本文档适用于 Apache Flink 的旧版本，建议使用 <a href="http://doc.flink-china.org/latest/">最新版本的文档</a> 。
    </div>
    
    

    
    





    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="http://flink-china.org"><img alt="Apache Flink" src="/1.1.0/page/img/navbar-brand-logo.jpg"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="hidden-sm "><a href="/1.1.0/">中文文档 1.1</a></li>

            <li class="hidden-sm "><a href="/1.1.0/features.html">特性</a></li>

            <!-- Quickstart -->
            <li class="dropdown">
              <a href="/1.1.0/quickstart" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">快速起步<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/quickstart/setup_quickstart.html">安装</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/run_example_quickstart.html">例子: 维基百科编辑流</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/java_api_quickstart.html">Java API</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/scala_api_quickstart.html">Scala API</a></li>
                
              </ul>
            </li>

            <!-- Setup -->
            <li class="dropdown">
              <a href="/1.1.0/setup" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">安装 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/setup/building.html">构建 Flink</a></li>
                
                <li class=""><a href="/1.1.0/setup/config.html">Configuration</a></li>
                

                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>部署</strong></li>
                
                
                <li class=""><a href="/1.1.0/setup/local_setup.html">本地</a></li>
                
                <li class=""><a href="/1.1.0/setup/cluster_setup.html">集群 (Standalone)</a></li>
                
                <li class=""><a href="/1.1.0/setup/yarn_setup.html">YARN</a></li>
                
                <li class=""><a href="/1.1.0/setup/gce_setup.html">Google Compute Engine</a></li>
                
                <li class=""><a href="/1.1.0/setup/jobmanager_high_availability.html">High Availability</a></li>
                
              </ul>
            </li>

            <!-- Programming Guides -->
            <li class="dropdown active">
              <a href="/1.1.0/apis" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">编程指南 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/apis/common/"><strong>基本概念</strong></a></li>
                
                <li class="active"><a href="/1.1.0/apis/streaming/"><strong>Streaming 指南</strong> (DataStream API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/batch/"><strong>Batch 指南</strong> (DataSet API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/best_practices.html">Best Practices</a></li>
                
                <li class=""><a href="/1.1.0/apis/cli.html">命令行接口（CLI）</a></li>
                
                <li class=""><a href="/1.1.0/apis/local_execution.html">本地执行</a></li>
                
                <li class=""><a href="/1.1.0/apis/cluster_execution.html">Cluster Execution</a></li>
                
                <li class=""><a href="/1.1.0/apis/scala_shell.html">Scala Shell</a></li>
                
                <li class=""><a href="/1.1.0/apis/java8.html">Java 8</a></li>
                
                <li class=""><a href="/1.1.0/apis/metrics.html">Metrics</a></li>
                
              </ul>
            </li>

            <!-- Libraries -->
            <li class="dropdown">
              <a href="/1.1.0/libs" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">类库 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/gelly.html">Graphs: Gelly</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/streaming/libs/cep.html">CEP</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/ml/">Machine Learning</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/table.html">Relational: Table</a></li>
                  
              </ul>
            </li>

            <!-- Internals -->
            <li class="dropdown">
              <a href="/1.1.0/internals" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">内部 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="http://flink.apache.org/how-to-contribute.html"><small><span class="glyphicon glyphicon-new-window"></span></small> How to Contribute</a></li>
                <li><a href="http://flink.apache.org/contribute-code.html#coding-guidelines"><small><span class="glyphicon glyphicon-new-window"></span></small> Coding Guidelines</a></li>
                
                
                <li class=""><a href="/1.1.0/internals/ide_setup.html">IDE Setup</a></li>
                
                <li class=""><a href="/1.1.0/internals/logging.html">Logging</a></li>
                
                <li class=""><a href="/1.1.0/internals/general_arch.html">Architecture and Process Model</a></li>
                
                <li class=""><a href="/1.1.0/internals/stream_checkpointing.html">Data Streaming的容错机制</a></li>
                
                <li class=""><a href="/1.1.0/internals/types_serialization.html">Type Extraction and Serialization</a></li>
                
                <li class=""><a href="/1.1.0/internals/monitoring_rest_api.html">Monitoring REST API</a></li>
                
                <li class=""><a href="/1.1.0/internals/job_scheduling.html">Jobs and Scheduling</a></li>
                
                <li class=""><a href="/1.1.0/internals/add_operator.html">How-To: Add an Operator</a></li>
                
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="hidden-sm" href="http://blog.flink-china.org" target="_blank">
            <small><span class="glyphicon glyphicon-new-window"></span></small> 博客</a></li>
            <li class="hidden-sm "><a href="/1.1.0/about/">关于本站</a></li>
          </ul>
          <form class="navbar-form navbar-right hidden-sm hidden-md" role="search" action="/1.1.0/search-results.html">
            <div class="form-group">
              <input type="text" class="form-control" size="16px" name="q" placeholder="Search all pages">
            </div>
            <button type="submit" class="btn btn-default">搜索</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <!-- Artifact name change warning. Remove for the 1.0 release. -->
    
    <div class="panel panel-default">
      <div class="panel-body"><strong>重要</strong>: 依赖于Scala的maven artifacts现在会添加一个Scala主版本的后缀，例如 "2.10" 或 "2.11". 请查阅<a href="https://cwiki.apache.org/confluence/display/FLINK/Maven+artifact+names+suffixed+with+Scala+version">迁移指南</a>.</div>
    </div>
    

    <!-- Breadcrumbs above the main heading -->
    <ol class="breadcrumb">
      

      
      
      

      

      <li><a href="/1.1.0/apis/streaming/fault_tolerance.html">容错</a></li>
      
      
      <li class="active">状态管理</li>
    </ol>

    <div class="text">
      <!-- Main heading -->
      <h1>状态管理</h1>

      <!-- Content -->
      

<p>Flink 中所有的转换操作看起来都像是函数调用（函数式处理术语），但它们实际上都是有状态的操作。
通过 Flink 的状态接口（state interface）或代码中的 checkpoint 实例变量，可以将 <em>每一个</em> 转换操作，如<code>map</code>、<code>filter</code>等，
变成有状态的操作。只要实现状态相关的接口，就可以在代码中将任意的实例变量注册为 <strong><em>托管的</em></strong> 状态变量。
通过这种方式，或者使用 Flink 原生的状态接口，Flink 能够定期对状态做一致性快照，并且在失败时从快照中恢复状态数据。</p>

<p>最终效果是，无论处理过程中有无失败，对任意状态的更新都是一致的。</p>

<p>首先，我们看一下如何保证状态变量在有处理失败情况下的状态一致性，然后来看一下 Flink 的状态接口。</p>

<p>默认情况下，状态的 checkpoint 会被保存在 JobManager 的内存中。对于较大的状态，Flink 也支持将 checkpoint 保存在文件系统中
（如HDFS、S3或任意挂载的 POSIX 文件系统），可以通过 <code>flink-conf.yaml</code> 配置文件或者 <code>StreamExecutionEnvironment.setStateBackend(…)</code>
代码来配置如何存储checkpoint。
<a href="/1.1.0/apis/streaming/state_backends.html">state backends</a> 描述了可用的状态存储后端以及如何配置它们。</p>

<ul id="markdown-toc">
  <li><a href="#使用-基于-keyvalue-的状态接口" id="markdown-toc-使用-基于-keyvalue-的状态接口">使用 基于 Key/Value 的状态接口</a>    <ul>
      <li><a href="#scala-datastream-api-中的状态" id="markdown-toc-scala-datastream-api-中的状态">Scala DataStream API 中的状态</a></li>
    </ul>
  </li>
  <li><a href="#对实例变量做-checkpoint" id="markdown-toc-对实例变量做-checkpoint">对实例变量做 checkpoint</a></li>
  <li><a href="#有状态的-source-函数" id="markdown-toc-有状态的-source-函数">有状态的 Source 函数</a></li>
  <li><a href="#在迭代job中的状态checkpoint" id="markdown-toc-在迭代job中的状态checkpoint">在迭代Job中的状态checkpoint</a></li>
</ul>

<h2 id="使用-基于-keyvalue-的状态接口">使用 基于 Key/Value 的状态接口</h2>

<p>基于 Key/Value 的状态接口提供了访问当前输入元素中所有 key 值状态的方法，这也意味着，这些状态只能用于<code>KeyedStream</code>之上，
可以通过 <code>stream.keyBy(...)</code> 来创建 <code>KeyedStream</code> 。</p>

<p>我们首先看一下可用的状态接口列表，以及如何在代码中使用它们。
Flink 中可用的状态接口有：</p>

<ul>
  <li>
    <p><code>ValueState&lt;T&gt;</code>：这个状态保存一个可被更新和获取的值，该值与输入数据的 key 对应，因此在多个 key 的情况下，对于每一个 key，
都可能会有一个不同的状态值。可以通过<code>update(T)</code>来更新状态值，并通过<code>T value()</code>来获取状态值。</p>
  </li>
  <li>
    <p><code>ListState&lt;T&gt;</code>：这个状态保存了一系列输入数据。可以通过<code>add(T)</code>往状态中追加数据，并通过<code>Iterable&lt;T&gt; get</code>返回一个<code>Iterable</code>来遍历所有数据。</p>
  </li>
  <li>
    <p><code>ReducingState&lt;T&gt;</code>：这个状态保存了一个对一系列数据进行聚合后的值。这个接口与<code>ListState</code>有点类似，但是通过<code>add(T)</code>添加的元素，会通过
指定的聚合方法<code>ReduceFunction</code>计算出一个聚合值。</p>
  </li>
</ul>

<p>所有的状态接口都有一个<code>clear()</code>方法，用于清除当前 key 所对应的状态。</p>

<p>需要注意的是，上述状态接口应仅用于状态交互。状态不一定保存在运行时的内存中，也可能保存在磁盘或者其他地方。
还需注意，获取到的状态值依赖于输入元素的 key 值，因此如果输入元素的 key 值不同，可能会导致对相同方法调用返回的状态值也不同。</p>

<p>通过创建一个<code>StateDescriptor</code>，可以得到一个包含特定名称的状态句柄（后面会提到，可以创建多个互不重名的状态句柄来引用多个不同的状态）。
状态所包含的值可能是一个用户自定义的函数，如<code>ReduceFunction</code>。根据想要获取的状态的不同，可以分别创建<code>ValueStateDescriptor</code>、
<code>ListStateDescriptor</code>或<code>ReducingStateDescriptor</code>状态句柄。</p>

<p>状态是通过<code>RuntimeContext</code>来访问的，因此只能在 <em>rich functions</em> 中访问状态。
<a href="/1.1.0/apis/common/#specifying-transformation-functions">这里</a> 有更详细的说明，稍后我们也将看到一个简短的示例。
<code>RichFunction</code> 中的 <code>RuntimeContext</code> 有以下获取状态的方法：</p>

<ul>
  <li><code>ValueState&lt;T&gt; getState(ValueStateDescriptor&lt;T&gt;)</code></li>
  <li><code>ReducingState&lt;T&gt; getReducingState(ReducingStateDescriptor&lt;T&gt;)</code></li>
  <li><code>ListState&lt;T&gt; getListState(ListStateDescriptor&lt;T&gt;)</code></li>
</ul>

<p>下面通过一个<code>FlatMapFunction</code>示例来演示如何使用状态相关接口：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountWindowAverage</span> <span class="kd">extends</span> <span class="n">RichFlatMapFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * ValueState 状态，第一个字段为 count 值，第二个字段为 sum 值</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="n">ValueState</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">sum</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">input</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// 访问状态值</span>
        <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">currentSum</span> <span class="o">=</span> <span class="n">sum</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>

        <span class="c1">// 更新状态的count值</span>
        <span class="n">currentSum</span><span class="o">.</span><span class="na">f0</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// 将输入值累加到sum中</span>
        <span class="n">currentSum</span><span class="o">.</span><span class="na">f1</span> <span class="o">+=</span> <span class="n">input</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>

        <span class="c1">// 更新状态值</span>
        <span class="n">sum</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">currentSum</span><span class="o">);</span>

        <span class="c1">// 如果 count 值 &gt;=2，则输出count 及平均值，并且清空状态</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentSum</span><span class="o">.</span><span class="na">f0</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="n">input</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">currentSum</span><span class="o">.</span><span class="na">f1</span> <span class="o">/</span> <span class="n">currentSum</span><span class="o">.</span><span class="na">f0</span><span class="o">));</span>
            <span class="n">sum</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ValueStateDescriptor</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">descriptor</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
                        <span class="s">&quot;average&quot;</span><span class="o">,</span> <span class="c1">// the state name</span>
                        <span class="n">TypeInformation</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="n">TypeHint</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;()</span> <span class="o">{}),</span> <span class="c1">// type information</span>
                        <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">));</span> <span class="c1">// default value of the state, if nothing was set</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 然后在一个流式程序中使用上面的代码（假设已经创建了名为env的StreamExecutionEnvironment）</span>
<span class="n">env</span><span class="o">.</span><span class="na">fromElements</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">7L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">))</span>
        <span class="o">.</span><span class="na">keyBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="k">new</span> <span class="nf">CountWindowAverage</span><span class="o">())</span>
        <span class="o">.</span><span class="na">print</span><span class="o">();</span>

<span class="c1">// 最终执行结果将会输出：(1,4) and (1,5)</span></code></pre></figure>

<p>上面的例子实现了一个很简单的计数窗口，其中 key 值为元组的第一个元素（上面的例子中值都为1）。我们的<code>RichFunction</code>会将 count 值
以及滑动的计数值保存在<code>ValueState</code>中，一旦 count 总数达到2，就会输出平均值并且清空状态，后续状态从0开始重新累计。
注意，如果输入元组的第一个字段值不同，我们将会保存一个不同的状态值。</p>

<h3 id="scala-datastream-api-中的状态">Scala DataStream API 中的状态</h3>

<p>除了上面提到的java的状态接口，Scala API 中也提供了在<code>keyedStream</code>之上针对<code>map()</code>或<code>flatMap()</code>进行<code>ValueState</code>更新的快捷操作。
用户代码首先获得<code>ValueState</code>的当前状态值（返回值为 <code>Option</code>类型），然后返回一个更新后的状态值，用于状态的更新。</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">stream</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">counts</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="n">stream</span>
  <span class="o">.</span><span class="n">keyBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">)</span>
  <span class="o">.</span><span class="n">mapWithState</span><span class="o">((</span><span class="n">in</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">),</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="n">count</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">c</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">in</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">)</span>
      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="o">(</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">)</span>
    <span class="o">})</span></code></pre></figure>

<h2 id="对实例变量做-checkpoint">对实例变量做 checkpoint</h2>

<p>通过<code>Checkpointed</code>接口，也可以对实例变量做 checkpoint 。</p>

<p>只要用户实现了<code>Checkpointed</code>接口，<code>snapshotState(…)</code> 和 <code>restoreState(…)</code>方法就会被调用，分别用于保存和恢复方法的状态。</p>

<p>除此之外，用户也可以实现<code>CheckpointNotifier</code>接口，这样在完成 checkpoint 的时候，会得到<code>notifyCheckpointComplete(long checkpointId)</code>
方法的回调通知。</p>

<p>需要注意的是，如果在 checkpoint 完成和发送通知之间发生了错误，则不能够保证用户一定会收到通知。
因此这种机制仅应被视为一种不可靠的通知，当你收到后续的 checkpoint 的通知时，它有可能是之前丢失的通知。</p>

<p>上面示例中的 <code>ValueState</code> 也可以用实例变量来实现：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountWindowAverage</span>
        <span class="kd">extends</span> <span class="n">RichFlatMapFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
        <span class="kd">implements</span> <span class="n">Checkpointed</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">sum</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">input</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// 更新count值</span>
        <span class="n">sum</span><span class="o">.</span><span class="na">f0</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// 将输入的count值累加到sum中</span>
        <span class="n">sum</span><span class="o">.</span><span class="na">f1</span> <span class="o">+=</span> <span class="n">input</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>


        <span class="c1">// 如果 count 值 &gt;=2，则输出count 及平均值，并且清空状态</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sum</span><span class="o">.</span><span class="na">f0</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="n">input</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">sum</span><span class="o">.</span><span class="na">f1</span> <span class="o">/</span> <span class="n">sum</span><span class="o">.</span><span class="na">f0</span><span class="o">));</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sum</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 仅当 sum 为null时创建状态变量，因为restoreState可能先于open()方法被调用</span>
            <span class="c1">// 此时 sum 可能已经被设置为被恢复的状态值</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 持续地持久化保存状态</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Serializable</span> <span class="nf">snapshotState</span><span class="o">(</span><span class="kt">long</span> <span class="n">checkpointId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">checkpointTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 出错时恢复状态</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restoreState</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="有状态的-source-函数">有状态的 Source 函数</h2>

<p>处理有状态的 source 需要比处理其他状态更加小心一点。为了保证状态更新和输出的原子性（当需要exactly-once的处理语义时），
在做 checkpoint 时需要获取从 source context 中获取锁。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CounterSource</span>
        <span class="kd">extends</span> <span class="n">RichParallelSourceFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="n">Checkpointed</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**  exactly-once语义中的当前 offset */</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">;</span>

    <span class="cm">/** job 是否运行的标识 */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">SourceContext</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getCheckpointLock</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 由于获得了checkpoint 锁，这里的输出和状态更新是原子的</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ctx</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">offset</span><span class="o">);</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">snapshotState</span><span class="o">(</span><span class="kt">long</span> <span class="n">checkpointId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">checkpointTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">offset</span><span class="o">;</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restoreState</span><span class="o">(</span><span class="n">Long</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>在有的操作中 可能需要知道该操作的 checkpoint 何时被 Flink 框架所确认，以便与外部进行交互。
具体可见：<code>flink.streaming.api.checkpoint.CheckpointNotifier</code> 接口。</p>

<h2 id="在迭代job中的状态checkpoint">在迭代Job中的状态checkpoint</h2>

<p>Flink 目前只保证非迭代 Job 的处理语义，在迭代的Job中开启 checkpoint 将会得到一个异常。
如果需要强制在迭代 Job 中开启 checkpoint 机制，则用户在开启 checkpoint 的同时还需要设置：<code>env.enableCheckpointing(interval, force = true)</code>。</p>

<p>注意，在迭代的循环边界中，如果出现失败，则处理的数据以及相关状态的变化都可能丢失。</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

      <div class="footer">
      发现错误？想参与编辑？
      <a href="https://github.com/flink-china/flink-china-doc/edit/1.1.0/apis/streaming/state.md" target="_blank">
        在 Github 上编辑此页！
      </a>
    </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/1.1.0/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
