<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.1.0 中文文档: 状态后端</title>
    <link rel="shortcut icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/1.1.0/page/css/flink.css">
    <link rel="stylesheet" href="/1.1.0/page/css/syntax.css">
    <link rel="stylesheet" href="/1.1.0/page/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    
    <div style="position:fixed; bottom:0; left:0; z-index:99999; width:100%; text-align:center; padding:15px; border-top:1px dashed #CE4B65; background:#f6f0e3; font-weight:bold">
       本文档适用于 Apache Flink 的旧版本，建议使用 <a href="http://doc.flink-china.org/latest/">最新版本的文档</a> 。
    </div>
    
    

    
    





    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="http://flink-china.org"><img alt="Apache Flink" src="/1.1.0/page/img/navbar-brand-logo.jpg"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="hidden-sm "><a href="/1.1.0/">中文文档 1.1</a></li>

            <li class="hidden-sm "><a href="/1.1.0/features.html">特性</a></li>

            <!-- Quickstart -->
            <li class="dropdown">
              <a href="/1.1.0/quickstart" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">快速起步<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/quickstart/setup_quickstart.html">安装</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/run_example_quickstart.html">例子: 维基百科编辑流</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/java_api_quickstart.html">Java API</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/scala_api_quickstart.html">Scala API</a></li>
                
              </ul>
            </li>

            <!-- Setup -->
            <li class="dropdown">
              <a href="/1.1.0/setup" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">安装 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/setup/building.html">构建 Flink</a></li>
                
                <li class=""><a href="/1.1.0/setup/config.html">Configuration</a></li>
                

                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>部署</strong></li>
                
                
                <li class=""><a href="/1.1.0/setup/local_setup.html">本地</a></li>
                
                <li class=""><a href="/1.1.0/setup/cluster_setup.html">集群 (Standalone)</a></li>
                
                <li class=""><a href="/1.1.0/setup/yarn_setup.html">YARN</a></li>
                
                <li class=""><a href="/1.1.0/setup/gce_setup.html">Google Compute Engine</a></li>
                
                <li class=""><a href="/1.1.0/setup/jobmanager_high_availability.html">High Availability</a></li>
                
              </ul>
            </li>

            <!-- Programming Guides -->
            <li class="dropdown active">
              <a href="/1.1.0/apis" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">编程指南 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/apis/common/"><strong>基本概念</strong></a></li>
                
                <li class="active"><a href="/1.1.0/apis/streaming/"><strong>Streaming 指南</strong> (DataStream API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/batch/"><strong>Batch 指南</strong> (DataSet API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/best_practices.html">Best Practices</a></li>
                
                <li class=""><a href="/1.1.0/apis/cli.html">命令行接口（CLI）</a></li>
                
                <li class=""><a href="/1.1.0/apis/local_execution.html">本地执行</a></li>
                
                <li class=""><a href="/1.1.0/apis/cluster_execution.html">Cluster Execution</a></li>
                
                <li class=""><a href="/1.1.0/apis/scala_shell.html">Scala Shell</a></li>
                
                <li class=""><a href="/1.1.0/apis/java8.html">Java 8</a></li>
                
                <li class=""><a href="/1.1.0/apis/metrics.html">Metrics</a></li>
                
              </ul>
            </li>

            <!-- Libraries -->
            <li class="dropdown">
              <a href="/1.1.0/libs" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">类库 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/gelly.html">Graphs: Gelly</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/streaming/libs/cep.html">CEP</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/ml/">Machine Learning</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/table.html">Relational: Table</a></li>
                  
              </ul>
            </li>

            <!-- Internals -->
            <li class="dropdown">
              <a href="/1.1.0/internals" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">内部 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="http://flink.apache.org/how-to-contribute.html"><small><span class="glyphicon glyphicon-new-window"></span></small> How to Contribute</a></li>
                <li><a href="http://flink.apache.org/contribute-code.html#coding-guidelines"><small><span class="glyphicon glyphicon-new-window"></span></small> Coding Guidelines</a></li>
                
                
                <li class=""><a href="/1.1.0/internals/ide_setup.html">IDE Setup</a></li>
                
                <li class=""><a href="/1.1.0/internals/logging.html">Logging</a></li>
                
                <li class=""><a href="/1.1.0/internals/general_arch.html">Architecture and Process Model</a></li>
                
                <li class=""><a href="/1.1.0/internals/stream_checkpointing.html">Data Streaming的容错机制</a></li>
                
                <li class=""><a href="/1.1.0/internals/types_serialization.html">Type Extraction and Serialization</a></li>
                
                <li class=""><a href="/1.1.0/internals/monitoring_rest_api.html">Monitoring REST API</a></li>
                
                <li class=""><a href="/1.1.0/internals/job_scheduling.html">Jobs and Scheduling</a></li>
                
                <li class=""><a href="/1.1.0/internals/add_operator.html">How-To: Add an Operator</a></li>
                
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="hidden-sm" href="http://blog.flink-china.org" target="_blank">
            <small><span class="glyphicon glyphicon-new-window"></span></small> 博客</a></li>
            <li class="hidden-sm "><a href="/1.1.0/about/">关于本站</a></li>
          </ul>
          <form class="navbar-form navbar-right hidden-sm hidden-md" role="search" action="/1.1.0/search-results.html">
            <div class="form-group">
              <input type="text" class="form-control" size="16px" name="q" placeholder="Search all pages">
            </div>
            <button type="submit" class="btn btn-default">搜索</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <!-- Artifact name change warning. Remove for the 1.0 release. -->
    
    <div class="panel panel-default">
      <div class="panel-body"><strong>重要</strong>: 依赖于Scala的maven artifacts现在会添加一个Scala主版本的后缀，例如 "2.10" 或 "2.11". 请查阅<a href="https://cwiki.apache.org/confluence/display/FLINK/Maven+artifact+names+suffixed+with+Scala+version">迁移指南</a>.</div>
    </div>
    

    <!-- Breadcrumbs above the main heading -->
    <ol class="breadcrumb">
      

      
      
      

      

      <li><a href="/1.1.0/apis/streaming/fault_tolerance.html">容错</a></li>
      
      
      <li class="active">状态后端</li>
    </ol>

    <div class="text">
      <!-- Main heading -->
      <h1>状态后端</h1>

      <!-- Content -->
      

<p>使用 <a href="index.html">Data Stream API</a> 的程序经常需要保存各种状态：</p>

<ul>
  <li>在触发窗口动作之前，窗口需要保存窗口数据或其聚合值</li>
  <li>转换操作可能使用 Key/Value 状态接口来保存状态</li>
  <li>转换操作可能通过实现 <code>Checkpointed</code> 接口以保证本地变量的容错性</li>
</ul>

<p>关于状态管理，请参考：streaming API中的文档：<a href="state.html">状态管理</a>。</p>

<p>当启用 checkpoint 时，上述的状态会通过 checkpoint 被持久化保存，并在失败时可以恢复，以防止数据丢失。
状态在内部如何表示、如何持久化以及存储在哪，依赖于用户所选择的 <strong>状态后端</strong>。</p>

<ul id="markdown-toc">
  <li><a href="#可用的状态后端" id="markdown-toc-可用的状态后端">可用的状态后端</a>    <ul>
      <li><a href="#memorystatebackend" id="markdown-toc-memorystatebackend">MemoryStateBackend</a></li>
      <li><a href="#fsstatebackend" id="markdown-toc-fsstatebackend">FsStateBackend</a></li>
      <li><a href="#rocksdbstatebackend" id="markdown-toc-rocksdbstatebackend">RocksDBStateBackend</a></li>
    </ul>
  </li>
  <li><a href="#配置状态后端" id="markdown-toc-配置状态后端">配置状态后端</a>    <ul>
      <li><a href="#在-job-中配置状态后端" id="markdown-toc-在-job-中配置状态后端">在 Job 中配置状态后端</a></li>
      <li><a href="#配置默认的状态后端" id="markdown-toc-配置默认的状态后端">配置默认的状态后端</a></li>
    </ul>
  </li>
</ul>

<h2 id="可用的状态后端">可用的状态后端</h2>

<p>Flink 内置了以下状态后端，可以直接使用：</p>

<ul>
  <li><em>MemoryStateBacked</em></li>
  <li><em>FsStateBackend</em></li>
  <li><em>RocksDBStateBackend</em></li>
</ul>

<p>默认情况下，系统会使用MemoryStateBacked。</p>

<h3 id="memorystatebackend">MemoryStateBackend</h3>

<p><em>MemoryStateBacked</em> 将数据以对象的形式存储在Java的堆内存中。基于 Key/Value 的状态以及窗口操作的算子内部会有一个哈希表，用于保存各种值。
在做 checkpoint 的时候，状态后端会对状态做快照，然后将其作为 checkpoint 确认消息的一部分发送到 master 的 JobManager，JobManager也会将其保存在堆内存中。</p>

<p>MemoryStateBackend的限制：</p>

<ul>
  <li>每个状态的大小默认被限制为5MB，该值可以在 MemoryStateBackend 的构造函数中进行调整</li>
  <li>无论配置的最大状态是多少，最终都不能超过 akka 的 最大frame 大小（见[Configuration](/1.1.0/setup/config.html）</li>
  <li>聚合后的状态必须能够放进 JobManager 的内存中</li>
</ul>

<p>以下场景推荐使用 MemoryStateBackend：</p>

<ul>
  <li>本地开发和调试</li>
  <li>只需要保存很少状态的 Job，如那些只由每次只生成一条记录的算子（如Map、FlatMap、Filter等）组合而成的 Job。Kafka Consumer 也只需要保存很少的状态。</li>
</ul>

<h3 id="fsstatebackend">FsStateBackend</h3>

<p><em>FsStateBackend</em> 通过一个文件系统的 URL 来配置，如 “hdfs://namenode:40010/flink/checkpoints” 或 “file:///data/flink/checkpoints”。</p>

<p>FsStateBackend 将运行时的数据保存在 TaskManager 的内存中。在做 checkpoint的时候，它会将状态快照存储到配置的文件系统目录中。
JobManager 的内存中仍然保存了少量的元数据（在高可用模式下，元数据会存储在对应的元数据 checkpoint中）。</p>

<p>以下场景推荐使用 FsStateBackend：</p>
<ul>
  <li>拥有很大状态、较长的窗口时间或较大的 Key/Value 状态的 Job</li>
  <li>需要高可用的情况</li>
</ul>

<h3 id="rocksdbstatebackend">RocksDBStateBackend</h3>

<p><em>RocksDBStateBackend</em> 也通过一个文件系统 URL 来配置，如 “hdfs://namenode:40010/flink/checkpoints” 或 “file:///data/flink/checkpoints”。</p>

<p>RocksDBStateBackend 将运行时的数据保存在 <a href="http://rocksdb.org">RocksDB</a> 中，其中 RocksDB 的数据默认存储在 TaskManager 的数据目录中。
在做 checkpoint 的时候，RocksDb 中的完整数据将会被存储到目标的文件系统中。
JobManager 的内存中仍然保存了少量的元数据（在高可用模式下，元数据会存储在对应的元数据 checkpoint中）。</p>

<p>以下场景推荐使用 RocksDBStateBackend：</p>
<ul>
  <li>拥有很大状态、较长的窗口时间或较大的 Key/Value 状态的 Job</li>
  <li>需要高可用的情况</li>
</ul>

<p>注意此时能够保存的状态大小仅受限于可用磁盘空间，与 FsStateBackend 需要将运行时的数据保存在内存中相比，
通过 RocksDBStateBackend 你可以保存非常大的状态。然而这也可能会降低最大吞吐量。</p>

<p><strong>注：</strong> 要使用 RocksDBStateBackend，还需要在你的项目中加入以下 maven 依赖：</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.flink<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>flink-statebackend-rocksdb_2.10<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>RocksDBStateBackend 目前并没有被包含在 Flink 的二进制分发包中，
参见<a href="/1.1.0/apis/cluster_execution.html#linking-with-modules-not-contained-in-the-binary-distribution">这里</a>了解如何引入 RocksDBStateBackend 并在集群中使用它。</p>

<h2 id="配置状态后端">配置状态后端</h2>

<p>可以在每个 Job 中配置不同的状态后端。当 Job 没有显式指定时，也可以配置一个默认的状态后端。</p>

<h3 id="在-job-中配置状态后端">在 Job 中配置状态后端</h3>

<p>Job 中的状态后端可以在 <code>StreamExecutionEnvironment</code> 中配置，如下代码示例：</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span>
<span class="n">env</span><span class="o">.</span><span class="na">setStateBackend</span><span class="o">(</span><span class="k">new</span> <span class="nf">FsStateBackend</span><span class="o">(</span><span class="s">&quot;hdfs://namenode:40010/flink/checkpoints&quot;</span><span class="o">));</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="n">getExecutionEnvironment</span><span class="o">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">setStateBackend</span><span class="o">(</span><span class="k">new</span> <span class="nc">FsStateBackend</span><span class="o">(</span><span class="s">&quot;hdfs://namenode:40010/flink/checkpoints&quot;</span><span class="o">))</span></code></pre></figure>

  </div>
</div>

<h3 id="配置默认的状态后端">配置默认的状态后端</h3>

<p>可以在 <code>flink-conf.yaml</code> 中使用 <code>state.backend</code> 配置项来配置默认的状态后端。</p>

<p>这个配置的值可以是：<em>jobmanager</em> （表示使用 MemoryStateBackend）， <em>filesystem</em> （使用 FsStateBackend），
或使用实现了状态后端工厂 <a href="https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/state/filesystem/FsStateBackendFactory.java">FsStateBackendFactory</a> 的全限定类名。</p>

<p>当默认的状态后端被设置为 <em>filesystem</em> 时，配置项 <code>state.backend.fs.checkpointdir</code> 指定了 checkpoint 数据的存储目录。</p>

<p>示例配置如下：</p>

<div class="highlight"><pre><code># The backend that will be used to store operator state checkpoints

state.backend: filesystem


# Directory for storing checkpoints

state.backend.fs.checkpointdir: hdfs://namenode:40010/flink/checkpoints
</code></pre></div>

      <div class="footer">
      发现错误？想参与编辑？
      <a href="https://github.com/flink-china/flink-china-doc/edit/1.1.0/apis/streaming/state_backends.md" target="_blank">
        在 Github 上编辑此页！
      </a>
    </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/1.1.0/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
