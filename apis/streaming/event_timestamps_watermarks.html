<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.1.0 中文文档: Generating Timestamps / Watermarks</title>
    <link rel="shortcut icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/1.1.0/page/css/flink.css">
    <link rel="stylesheet" href="/1.1.0/page/css/syntax.css">
    <link rel="stylesheet" href="/1.1.0/page/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    
    <div style="position:fixed; bottom:0; left:0; z-index:99999; width:100%; text-align:center; padding:15px; border-top:1px dashed #CE4B65; background:#f6f0e3; font-weight:bold">
       本文档适用于 Apache Flink 的旧版本，建议使用 <a href="http://doc.flink-china.org/latest/">最新版本的文档</a> 。
    </div>
    
    

    
    





    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="http://flink-china.org"><img alt="Apache Flink" src="/1.1.0/page/img/navbar-brand-logo.jpg"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="hidden-sm "><a href="/1.1.0/">中文文档 1.1</a></li>

            <li class="hidden-sm "><a href="/1.1.0/features.html">特性</a></li>

            <!-- Quickstart -->
            <li class="dropdown">
              <a href="/1.1.0/quickstart" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">快速起步<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/quickstart/setup_quickstart.html">安装</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/run_example_quickstart.html">例子: 维基百科编辑流</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/java_api_quickstart.html">Java API</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/scala_api_quickstart.html">Scala API</a></li>
                
              </ul>
            </li>

            <!-- Setup -->
            <li class="dropdown">
              <a href="/1.1.0/setup" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">安装 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/setup/building.html">构建 Flink</a></li>
                
                <li class=""><a href="/1.1.0/setup/config.html">Configuration</a></li>
                

                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>部署</strong></li>
                
                
                <li class=""><a href="/1.1.0/setup/local_setup.html">本地</a></li>
                
                <li class=""><a href="/1.1.0/setup/cluster_setup.html">集群 (Standalone)</a></li>
                
                <li class=""><a href="/1.1.0/setup/yarn_setup.html">YARN</a></li>
                
                <li class=""><a href="/1.1.0/setup/gce_setup.html">Google Compute Engine</a></li>
                
                <li class=""><a href="/1.1.0/setup/jobmanager_high_availability.html">High Availability</a></li>
                
              </ul>
            </li>

            <!-- Programming Guides -->
            <li class="dropdown active">
              <a href="/1.1.0/apis" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">编程指南 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/apis/common/"><strong>基本概念</strong></a></li>
                
                <li class="active"><a href="/1.1.0/apis/streaming/"><strong>Streaming 指南</strong> (DataStream API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/batch/"><strong>Batch 指南</strong> (DataSet API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/best_practices.html">Best Practices</a></li>
                
                <li class=""><a href="/1.1.0/apis/cli.html">命令行接口（CLI）</a></li>
                
                <li class=""><a href="/1.1.0/apis/local_execution.html">本地执行</a></li>
                
                <li class=""><a href="/1.1.0/apis/cluster_execution.html">Cluster Execution</a></li>
                
                <li class=""><a href="/1.1.0/apis/scala_shell.html">Scala Shell</a></li>
                
                <li class=""><a href="/1.1.0/apis/java8.html">Java 8</a></li>
                
                <li class=""><a href="/1.1.0/apis/metrics.html">Metrics</a></li>
                
              </ul>
            </li>

            <!-- Libraries -->
            <li class="dropdown">
              <a href="/1.1.0/libs" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">类库 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/gelly.html">Graphs: Gelly</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/streaming/libs/cep.html">CEP</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/ml/">Machine Learning</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/table.html">Relational: Table</a></li>
                  
              </ul>
            </li>

            <!-- Internals -->
            <li class="dropdown">
              <a href="/1.1.0/internals" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">内部 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="http://flink.apache.org/how-to-contribute.html"><small><span class="glyphicon glyphicon-new-window"></span></small> How to Contribute</a></li>
                <li><a href="http://flink.apache.org/contribute-code.html#coding-guidelines"><small><span class="glyphicon glyphicon-new-window"></span></small> Coding Guidelines</a></li>
                
                
                <li class=""><a href="/1.1.0/internals/ide_setup.html">IDE Setup</a></li>
                
                <li class=""><a href="/1.1.0/internals/logging.html">Logging</a></li>
                
                <li class=""><a href="/1.1.0/internals/general_arch.html">Architecture and Process Model</a></li>
                
                <li class=""><a href="/1.1.0/internals/stream_checkpointing.html">Data Streaming的容错机制</a></li>
                
                <li class=""><a href="/1.1.0/internals/types_serialization.html">Type Extraction and Serialization</a></li>
                
                <li class=""><a href="/1.1.0/internals/monitoring_rest_api.html">Monitoring REST API</a></li>
                
                <li class=""><a href="/1.1.0/internals/job_scheduling.html">Jobs and Scheduling</a></li>
                
                <li class=""><a href="/1.1.0/internals/add_operator.html">How-To: Add an Operator</a></li>
                
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="hidden-sm" href="http://blog.flink-china.org" target="_blank">
            <small><span class="glyphicon glyphicon-new-window"></span></small> 博客</a></li>
            <li class="hidden-sm "><a href="/1.1.0/about/">关于本站</a></li>
          </ul>
          <form class="navbar-form navbar-right hidden-sm hidden-md" role="search" action="/1.1.0/search-results.html">
            <div class="form-group">
              <input type="text" class="form-control" size="16px" name="q" placeholder="Search all pages">
            </div>
            <button type="submit" class="btn btn-default">搜索</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <!-- Artifact name change warning. Remove for the 1.0 release. -->
    
    <div class="panel panel-default">
      <div class="panel-body"><strong>重要</strong>: 依赖于Scala的maven artifacts现在会添加一个Scala主版本的后缀，例如 "2.10" 或 "2.11". 请查阅<a href="https://cwiki.apache.org/confluence/display/FLINK/Maven+artifact+names+suffixed+with+Scala+version">迁移指南</a>.</div>
    </div>
    

    <!-- Breadcrumbs above the main heading -->
    <ol class="breadcrumb">
      

      
      
      

      

      <li><a href="/1.1.0/apis/streaming/event_time.html">Event Time</a></li>
      
      
      <li class="active">Generating Timestamps / Watermarks</li>
    </ol>

    <div class="text">
      <!-- Main heading -->
      <h1>Generating Timestamps / Watermarks</h1>

      <!-- Content -->
      

<ul id="markdown-toc">
  <li><a href="#assigning-timestamps" id="markdown-toc-assigning-timestamps">Assigning Timestamps</a>    <ul>
      <li><a href="#source-functions-with-timestamps-and-watermarks" id="markdown-toc-source-functions-with-timestamps-and-watermarks">Source Functions with Timestamps and Watermarks</a></li>
      <li><a href="#timestamp-assigners--watermark-generators" id="markdown-toc-timestamp-assigners--watermark-generators">Timestamp Assigners / Watermark Generators</a></li>
    </ul>
  </li>
</ul>

<p>This section is relevant for program running on <strong>Event Time</strong>. For an introduction to <em>Event Time</em>,
<em>Processing Time</em>, and <em>Ingestion Time</em>, please refer to the <a href="/1.1.0/apis/streaming/event_time.html">event time introduction</a></p>

<p>To work with <em>Event Time</em>, streaming programs need to set the <em>time characteristic</em> accordingly.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span>
<span class="n">env</span><span class="o">.</span><span class="na">setStreamTimeCharacteristic</span><span class="o">(</span><span class="n">TimeCharacteristic</span><span class="o">.</span><span class="na">EventTime</span><span class="o">);</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="n">getExecutionEnvironment</span>
<span class="n">env</span><span class="o">.</span><span class="n">setStreamTimeCharacteristic</span><span class="o">(</span><span class="nc">TimeCharacteristic</span><span class="o">.</span><span class="nc">EventTime</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<h2 id="assigning-timestamps">Assigning Timestamps</h2>

<p>In order to work with <em>Event Time</em>, Flink needs to know the events’ <em>timestamps</em>, meaning each element in the
stream needs to get its event timestamp <em>assigned</em>. That happens usually by accessing/extracting the
timestamp from some field in the element.</p>

<p>Timestamp assignment goes hand-in-hand with generating watermarks, which tell the system about 
the progress in event time.</p>

<p>There are two ways to assign timestamps and generate Watermarks:</p>

<ol>
  <li>Directly in the data stream source</li>
  <li>Via a <em>TimestampAssigner / WatermarkGenerator</em></li>
</ol>

<h3 id="source-functions-with-timestamps-and-watermarks">Source Functions with Timestamps and Watermarks</h3>

<p>Stream sources can also directly assign timestamps to the elements they produce and emit Watermarks. In that case,
no Timestamp Assigner is needed.</p>

<p>To assign a timestamp to an element in the soruce directly, the source must use the <code>collectWithTimestamp(...)</code>
method on the <code>SourceContext</code>. To generate Watermarks, the source must call the <code>emitWatermark(Watermark)</code> function.</p>

<p>Below is a simple example of a source <em>(non-checkpointed)</em> that assigns timestamps and generates Watermarks
depending on special events:</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">SourceContext</span><span class="o">&lt;</span><span class="n">MyType</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="k">while</span> <span class="o">(</span><span class="cm">/* condition */</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">MyType</span> <span class="n">next</span> <span class="o">=</span> <span class="n">getNext</span><span class="o">();</span>
		<span class="n">ctx</span><span class="o">.</span><span class="na">collectWithTimestamp</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">next</span><span class="o">.</span><span class="na">getEventTimestamp</span><span class="o">());</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">hasWatermarkTime</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">ctx</span><span class="o">.</span><span class="na">emitWatermark</span><span class="o">(</span><span class="k">new</span> <span class="nf">Watermark</span><span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">getWatermarkTime</span><span class="o">()));</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">SourceContext</span><span class="o">[</span><span class="kt">MyType</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
	<span class="k">while</span> <span class="o">(</span><span class="cm">/* condition */</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">val</span> <span class="n">next</span><span class="k">:</span> <span class="kt">MyType</span> <span class="o">=</span> <span class="n">getNext</span><span class="o">()</span>
		<span class="n">ctx</span><span class="o">.</span><span class="n">collectWithTimestamp</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">next</span><span class="o">.</span><span class="n">eventTimestamp</span><span class="o">)</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="n">hasWatermarkTime</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">ctx</span><span class="o">.</span><span class="n">emitWatermark</span><span class="o">(</span><span class="k">new</span> <span class="nc">Watermark</span><span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="n">getWatermarkTime</span><span class="o">))</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p><em>Note:</em> If the streaming program uses a TimestampAssigner on a stream where elements have a timestamp already,
those timestamps will be overwritten by the TimestampAssigner. Similarly, Watermarks will be overwritten as well.</p>

<h3 id="timestamp-assigners--watermark-generators">Timestamp Assigners / Watermark Generators</h3>

<p>Timestamp Assigners take a stream and produce a new stream with timestamped elements and watermarks. If the
original stream had timestamps or watermarks already, the timestamp assigner overwrites those.</p>

<p>The timestamp assigners occur usually direct after the data source, but it is not strictly required to. A
common pattern is for example to parse (<em>MapFunction</em>) and filter (<em>FilterFunction</em>) before the timestamp assigner.
In any case, the timestamp assigner needs to occur before the first operation on event time
(such as the first window operation).</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span>
<span class="n">env</span><span class="o">.</span><span class="na">setStreamTimeCharacteristic</span><span class="o">(</span><span class="n">TimeCharacteristic</span><span class="o">.</span><span class="na">EventTime</span><span class="o">);</span>

<span class="n">DataStream</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="na">addSource</span><span class="o">(</span><span class="k">new</span> <span class="n">FlinkKafkaConsumer09</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;(</span><span class="n">topic</span><span class="o">,</span> <span class="n">schema</span><span class="o">,</span> <span class="n">props</span><span class="o">));</span>

<span class="n">DataStream</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="n">withTimestampsAndWatermarks</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span> <span class="n">event</span> <span class="o">-&gt;</span> <span class="n">event</span><span class="o">.</span><span class="na">severity</span><span class="o">()</span> <span class="o">==</span> <span class="n">WARNING</span> <span class="o">)</span>
        <span class="o">.</span><span class="na">assignTimestampsAndWatermarks</span><span class="o">(</span><span class="k">new</span> <span class="nf">MyTimestampsAndWatermarks</span><span class="o">());</span>

<span class="n">withTimestampsAndWatermarks</span>
        <span class="o">.</span><span class="na">keyBy</span><span class="o">(</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">event</span><span class="o">.</span><span class="na">getGroup</span><span class="o">()</span> <span class="o">)</span>
        <span class="o">.</span><span class="na">timeWindow</span><span class="o">(</span><span class="n">Time</span><span class="o">.</span><span class="na">seconds</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
        <span class="o">.</span><span class="na">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">)</span>
        <span class="o">.</span><span class="na">addSink</span><span class="o">(...);</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="n">getExecutionEnvironment</span>
<span class="n">env</span><span class="o">.</span><span class="n">setStreamTimeCharacteristic</span><span class="o">(</span><span class="nc">TimeCharacteristic</span><span class="o">.</span><span class="nc">EventTime</span><span class="o">)</span>

<span class="k">val</span> <span class="n">stream</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">]</span> <span class="k">=</span> <span class="n">env</span><span class="o">.</span><span class="n">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlinkKafkaConsumer09</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">](</span><span class="n">topic</span><span class="o">,</span> <span class="n">schema</span><span class="o">,</span> <span class="n">props</span><span class="o">))</span>

<span class="k">val</span> <span class="n">withTimestampsAndWatermarks</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">]</span> <span class="k">=</span> <span class="n">stream</span>
        <span class="o">.</span><span class="n">filter</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="nc">WARNING</span> <span class="o">)</span>
        <span class="o">.</span><span class="n">assignTimestampsAndWatermarks</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyTimestampsAndWatermarks</span><span class="o">())</span>

<span class="n">withTimestampsAndWatermarks</span>
        <span class="o">.</span><span class="n">keyBy</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">getGroup</span> <span class="o">)</span>
        <span class="o">.</span><span class="n">timeWindow</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">seconds</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
        <span class="o">.</span><span class="n">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">)</span>
        <span class="o">.</span><span class="n">addSink</span><span class="o">(...)</span></code></pre></figure>

  </div>
</div>

<h4 id="with-ascending-timestamps"><strong>With Ascending timestamps</strong></h4>

<p>The simplest case for generating watermarks is the case where timestamps within one source occur in ascending order.
In that case, the current timestamp can always act as a watermark, because no lower timestamps will occur any more.</p>

<p>Note that it is only necessary that timestamps are ascending <em>per parallel data source instance</em>. For example, if
in a specific setup one Kafka partition is read by one parallel data source instance, then it is only necessary that
timestamps are ascending within each Kafka partition. Flink’s Watermark merging mechanism will generate correct
whenever parallel streams are shuffled, unioned, connected, or merged.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">DataStream</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">DataStream</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="n">withTimestampsAndWatermarks</span> <span class="o">=</span> 
    <span class="n">stream</span><span class="o">.</span><span class="na">assignTimestampsAndWatermarks</span><span class="o">(</span><span class="k">new</span> <span class="n">AscendingTimestampExtractor</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">extractAscendingTimestamp</span><span class="o">(</span><span class="n">MyEvent</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">();</span>
        <span class="o">}</span>
<span class="o">});</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">stream</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">withTimestampsAndWatermarks</span> <span class="k">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">assignAscendingTimestamps</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">getCreationTime</span> <span class="o">)</span></code></pre></figure>

  </div>
</div>

<p><em>Note:</em> The generation of watermarks on ascending timestamps is a special case of the periodic watermark
generation described in the next section.</p>

<h4 id="with-periodic-watermarks"><strong>With Periodic Watermarks</strong></h4>

<p>The <code>AssignerWithPeriodicWatermarks</code> assigns timestamps and generate watermarks periodically (possibly depending
the stream elements, or purely based on processing time).</p>

<p>The interval (every <em>n</em> milliseconds) in which the watermark will be generated is defined via
<code>ExecutionConfig.setAutoWatermarkInterval(...)</code>. Each time, the assigner’s <code>getCurrentWatermark()</code> method will be
called, and a new Watermark will be emitted, if the returned Watermark is non-null and larger than the previous
Watermark.</p>

<p>Two simple examples of timestamp assigners with periodic watermark generation are below.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * This generator generates watermarks assuming that elements come out of order to a certain degree only.</span>
<span class="cm"> * The latest elements for a certain timestamp t will arrive at most n milliseconds after the earliest</span>
<span class="cm"> * elements for timestamp t.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BoundedOutOfOrdernessGenerator</span> <span class="kd">extends</span> <span class="n">AssignerWithPeriodicWatermarks</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">maxOutOfOrderness</span> <span class="o">=</span> <span class="mi">3500</span><span class="o">;</span> <span class="c1">// 3.5 seconds</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">currentMaxTimestamp</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">extractTimestamp</span><span class="o">(</span><span class="n">MyEvent</span> <span class="n">element</span><span class="o">,</span> <span class="kt">long</span> <span class="n">previousElementTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">();</span> 
        <span class="n">currentMaxTimestamp</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">timestamp</span><span class="o">,</span> <span class="n">currentMaxTimestamp</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">timestamp</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Watermark</span> <span class="nf">getCurrentWatermark</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// return the watermark as current highest timestamp minus the out-of-orderness bound</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Watermark</span><span class="o">(</span><span class="n">currentMaxTimestamp</span> <span class="o">-</span> <span class="n">maxOutOfOrderness</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**</span>
<span class="cm"> * This generator generates watermarks that are lagging behind processing time by a certain amount.</span>
<span class="cm"> * It assumes that elements arrive in Flink after at most a certain time.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimeLagWatermarkGenerator</span> <span class="kd">extends</span> <span class="n">AssignerWithPeriodicWatermarks</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">maxTimeLag</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span> <span class="c1">// 5 seconds</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">extractTimestamp</span><span class="o">(</span><span class="n">MyEvent</span> <span class="n">element</span><span class="o">,</span> <span class="kt">long</span> <span class="n">previousElementTimestamp</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Watermark</span> <span class="nf">getCurrentWatermark</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// return the watermark as current time minus the maximum time lag </span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Watermark</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">maxTimeLag</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/**</span>
<span class="cm"> * This generator generates watermarks assuming that elements come out of order to a certain degree only.</span>
<span class="cm"> * The latest elements for a certain timestamp t will arrive at most n milliseconds after the earliest</span>
<span class="cm"> * elements for timestamp t.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">BoundedOutOfOrdernessGenerator</span> <span class="k">extends</span> <span class="nc">AssignerWithPeriodicWatermarks</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">]</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">maxOutOfOrderness</span> <span class="k">=</span> <span class="mi">3500L</span><span class="o">;</span> <span class="c1">// 3.5 seconds</span>

    <span class="k">var</span> <span class="n">currentMaxTimestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">;</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">extractTimestamp</span><span class="o">(</span><span class="n">element</span><span class="k">:</span> <span class="kt">MyEvent</span><span class="o">,</span> <span class="n">previousElementTimestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">timestamp</span> <span class="k">=</span> <span class="n">element</span><span class="o">.</span><span class="n">getCreationTime</span><span class="o">()</span> 
        <span class="n">currentMaxTimestamp</span> <span class="k">=</span> <span class="n">max</span><span class="o">(</span><span class="n">timestamp</span><span class="o">,</span> <span class="n">currentMaxTimestamp</span><span class="o">)</span>
        <span class="n">timestamp</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">getCurrentWatermark</span><span class="o">()</span><span class="k">:</span> <span class="kt">Watermark</span> <span class="o">=</span> <span class="o">{</span>
        <span class="c1">// return the watermark as current highest timestamp minus the out-of-orderness bound</span>
        <span class="k">new</span> <span class="nc">Watermark</span><span class="o">(</span><span class="n">currentMaxTimestamp</span> <span class="o">-</span> <span class="n">maxOutOfOrderness</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**</span>
<span class="cm"> * This generator generates watermarks that are lagging behind processing time by a certain amount.</span>
<span class="cm"> * It assumes that elements arrive in Flink after at most a certain time.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">TimeLagWatermarkGenerator</span> <span class="k">extends</span> <span class="nc">AssignerWithPeriodicWatermarks</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">]</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">maxTimeLag</span> <span class="k">=</span> <span class="mi">5000L</span><span class="o">;</span> <span class="c1">// 5 seconds</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">extractTimestamp</span><span class="o">(</span><span class="n">element</span><span class="k">:</span> <span class="kt">MyEvent</span><span class="o">,</span> <span class="n">previousElementTimestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">element</span><span class="o">.</span><span class="n">getCreationTime</span>
    <span class="o">}</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">getCurrentWatermark</span><span class="o">()</span><span class="k">:</span> <span class="kt">Watermark</span> <span class="o">=</span> <span class="o">{</span>
        <span class="c1">// return the watermark as current time minus the maximum time lag </span>
        <span class="k">new</span> <span class="nc">Watermark</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">maxTimeLag</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<h4 id="with-punctuated-watermarks"><strong>With Punctuated Watermarks</strong></h4>

<p>To generate Watermarks whenever a certain event indicates that a new watermark can be generated, use the
<code>AssignerWithPunctuatedWatermarks</code>. For this class, Flink will first call the <code>extractTimestamp(...)</code> method
to assign the element a timestamp, and then immediately call for that element the
<code>checkAndGetNextWatermark(...)</code> method.</p>

<p>The <code>checkAndGetNextWatermark(...)</code> method gets the timestamp that was assigned in the <code>extractTimestamp(...)</code>
method, and can decide whether it wants to generate a Watermark. Whenever the <code>checkAndGetNextWatermark(...)</code>
method returns a non-null Watermark, and that Watermark is larger than the latest previous Watermark, that
new Watermark will be emitted.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PunctuatedAssigner</span> <span class="kd">extends</span> <span class="n">AssignerWithPunctuatedWatermarks</span><span class="o">&lt;</span><span class="n">MyEvent</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">extractTimestamp</span><span class="o">(</span><span class="n">MyEvent</span> <span class="n">element</span><span class="o">,</span> <span class="kt">long</span> <span class="n">previousElementTimestamp</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Watermark</span> <span class="nf">checkAndGetNextWatermark</span><span class="o">(</span><span class="n">MyEvent</span> <span class="n">lastElement</span><span class="o">,</span> <span class="kt">long</span> <span class="n">extractedTimestamp</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="na">hasWatermarkMarker</span><span class="o">()</span> <span class="o">?</span> <span class="k">new</span> <span class="nf">Watermark</span><span class="o">(</span><span class="n">extractedTimestamp</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">PunctuatedAssigner</span> <span class="k">extends</span> <span class="nc">AssignerWithPunctuatedWatermarks</span><span class="o">[</span><span class="kt">MyEvent</span><span class="o">]</span> <span class="o">{</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">extractTimestamp</span><span class="o">(</span><span class="n">element</span><span class="k">:</span> <span class="kt">MyEvent</span><span class="o">,</span> <span class="n">previousElementTimestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
		<span class="n">element</span><span class="o">.</span><span class="n">getCreationTime</span>
	<span class="o">}</span>

	<span class="k">override</span> <span class="k">def</span> <span class="n">checkAndGetNextWatermark</span><span class="o">(</span><span class="n">lastElement</span><span class="k">:</span> <span class="kt">MyEvent</span><span class="o">,</span> <span class="n">extractedTimestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Watermark</span> <span class="o">=</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="n">hasWatermarkMarker</span><span class="o">())</span> <span class="k">new</span> <span class="nc">Watermark</span><span class="o">(</span><span class="n">extractedTimestamp</span><span class="o">)</span> <span class="k">else</span> <span class="kc">null</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p><em>Note:</em> It is possible to generate a watermark on every single event. However, because each watermark causes some
computation downstream, an excessive number of watermarks slows down performance.</p>


      <div class="footer">
      发现错误？想参与编辑？
      <a href="https://github.com/flink-china/flink-china-doc/edit/1.1.0/apis/streaming/event_timestamps_watermarks.md" target="_blank">
        在 Github 上编辑此页！
      </a>
    </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/1.1.0/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
