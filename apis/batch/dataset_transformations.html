<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.1.0 中文文档: DataSet Transformations</title>
    <link rel="shortcut icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/1.1.0/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/1.1.0/page/css/flink.css">
    <link rel="stylesheet" href="/1.1.0/page/css/syntax.css">
    <link rel="stylesheet" href="/1.1.0/page/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    
    <div style="position:fixed; bottom:0; left:0; z-index:99999; width:100%; text-align:center; padding:15px; border-top:1px dashed #CE4B65; background:#f6f0e3; font-weight:bold">
       本文档适用于 Apache Flink 的旧版本，建议使用 <a href="http://doc.flink-china.org/latest/">最新版本的文档</a> 。
    </div>
    
    

    
    





    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="http://flink-china.org"><img alt="Apache Flink" src="/1.1.0/page/img/navbar-brand-logo.jpg"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="hidden-sm "><a href="/1.1.0/">中文文档 1.1</a></li>

            <li class="hidden-sm "><a href="/1.1.0/features.html">特性</a></li>

            <!-- Quickstart -->
            <li class="dropdown">
              <a href="/1.1.0/quickstart" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">快速起步<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/quickstart/setup_quickstart.html">安装</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/run_example_quickstart.html">例子: 维基百科编辑流</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/java_api_quickstart.html">Java API</a></li>
                
                <li class=""><a href="/1.1.0/quickstart/scala_api_quickstart.html">Scala API</a></li>
                
              </ul>
            </li>

            <!-- Setup -->
            <li class="dropdown">
              <a href="/1.1.0/setup" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">安装 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/setup/building.html">构建 Flink</a></li>
                
                <li class=""><a href="/1.1.0/setup/config.html">Configuration</a></li>
                

                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>部署</strong></li>
                
                
                <li class=""><a href="/1.1.0/setup/local_setup.html">本地</a></li>
                
                <li class=""><a href="/1.1.0/setup/cluster_setup.html">集群 (Standalone)</a></li>
                
                <li class=""><a href="/1.1.0/setup/yarn_setup.html">YARN</a></li>
                
                <li class=""><a href="/1.1.0/setup/gce_setup.html">Google Compute Engine</a></li>
                
                <li class=""><a href="/1.1.0/setup/jobmanager_high_availability.html">High Availability</a></li>
                
              </ul>
            </li>

            <!-- Programming Guides -->
            <li class="dropdown active">
              <a href="/1.1.0/apis" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">编程指南 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/1.1.0/apis/common/"><strong>基本概念</strong></a></li>
                
                <li class=""><a href="/1.1.0/apis/streaming/"><strong>Streaming 指南</strong> (DataStream API)</a></li>
                
                <li class="active"><a href="/1.1.0/apis/batch/"><strong>Batch 指南</strong> (DataSet API)</a></li>
                
                <li class=""><a href="/1.1.0/apis/best_practices.html">Best Practices</a></li>
                
                <li class=""><a href="/1.1.0/apis/cli.html">命令行接口（CLI）</a></li>
                
                <li class=""><a href="/1.1.0/apis/local_execution.html">本地执行</a></li>
                
                <li class=""><a href="/1.1.0/apis/cluster_execution.html">Cluster Execution</a></li>
                
                <li class=""><a href="/1.1.0/apis/scala_shell.html">Scala Shell</a></li>
                
                <li class=""><a href="/1.1.0/apis/java8.html">Java 8</a></li>
                
                <li class=""><a href="/1.1.0/apis/metrics.html">Metrics</a></li>
                
              </ul>
            </li>

            <!-- Libraries -->
            <li class="dropdown">
              <a href="/1.1.0/libs" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">类库 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/gelly.html">Graphs: Gelly</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/streaming/libs/cep.html">CEP</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/ml/">Machine Learning</a></li>
                  
                  <li class=""><a href="/1.1.0/apis/batch/libs/table.html">Relational: Table</a></li>
                  
              </ul>
            </li>

            <!-- Internals -->
            <li class="dropdown">
              <a href="/1.1.0/internals" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">内部 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="http://flink.apache.org/how-to-contribute.html"><small><span class="glyphicon glyphicon-new-window"></span></small> How to Contribute</a></li>
                <li><a href="http://flink.apache.org/contribute-code.html#coding-guidelines"><small><span class="glyphicon glyphicon-new-window"></span></small> Coding Guidelines</a></li>
                
                
                <li class=""><a href="/1.1.0/internals/ide_setup.html">IDE Setup</a></li>
                
                <li class=""><a href="/1.1.0/internals/logging.html">Logging</a></li>
                
                <li class=""><a href="/1.1.0/internals/general_arch.html">Architecture and Process Model</a></li>
                
                <li class=""><a href="/1.1.0/internals/stream_checkpointing.html">Data Streaming的容错机制</a></li>
                
                <li class=""><a href="/1.1.0/internals/types_serialization.html">Type Extraction and Serialization</a></li>
                
                <li class=""><a href="/1.1.0/internals/monitoring_rest_api.html">Monitoring REST API</a></li>
                
                <li class=""><a href="/1.1.0/internals/job_scheduling.html">Jobs and Scheduling</a></li>
                
                <li class=""><a href="/1.1.0/internals/add_operator.html">How-To: Add an Operator</a></li>
                
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="hidden-sm" href="http://blog.flink-china.org" target="_blank">
            <small><span class="glyphicon glyphicon-new-window"></span></small> 博客</a></li>
            <li class="hidden-sm "><a href="/1.1.0/about/">关于本站</a></li>
          </ul>
          <form class="navbar-form navbar-right hidden-sm hidden-md" role="search" action="/1.1.0/search-results.html">
            <div class="form-group">
              <input type="text" class="form-control" size="16px" name="q" placeholder="Search all pages">
            </div>
            <button type="submit" class="btn btn-default">搜索</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <!-- Artifact name change warning. Remove for the 1.0 release. -->
    
    <div class="panel panel-default">
      <div class="panel-body"><strong>重要</strong>: 依赖于Scala的maven artifacts现在会添加一个Scala主版本的后缀，例如 "2.10" 或 "2.11". 请查阅<a href="https://cwiki.apache.org/confluence/display/FLINK/Maven+artifact+names+suffixed+with+Scala+version">迁移指南</a>.</div>
    </div>
    

    <!-- Breadcrumbs above the main heading -->
    <ol class="breadcrumb">
      

      
      
      

      

      <li><a href="/1.1.0/apis/batch/">DataSet API</a></li>
      
      
      <li class="active">Transformations</li>
    </ol>

    <div class="text">
      <!-- Main heading -->
      <h1>DataSet Transformations</h1>

      <!-- Content -->
      

<blockquote>
  <p>注：本节未经校验，如有问题欢迎提issue</p>
</blockquote>

<p>本文档将进一步介绍DataSets的transformation。 如果想要一个基本了解，可以参考<a href="index.html">Programming Guide</a>。</p>

<p>在数据集中zip元素并赋给元素index时， 可以参考<a href="zip_elements_guide.html">Zip Elements Guide</a>.</p>

<ul id="markdown-toc">
  <li><a href="#map" id="markdown-toc-map">Map</a></li>
  <li><a href="#flatmap" id="markdown-toc-flatmap">FlatMap</a></li>
  <li><a href="#mappartition" id="markdown-toc-mappartition">MapPartition</a></li>
  <li><a href="#filter" id="markdown-toc-filter">Filter</a></li>
  <li><a href="#project-tuple-datasets-only-javapython-api-only" id="markdown-toc-project-tuple-datasets-only-javapython-api-only">Project (Tuple DataSets only) (Java/Python API Only)</a></li>
  <li><a href="#transformations-on-grouped-dataset" id="markdown-toc-transformations-on-grouped-dataset">Transformations on Grouped DataSet</a></li>
  <li><a href="#reduce-on-grouped-dataset" id="markdown-toc-reduce-on-grouped-dataset">Reduce on Grouped DataSet</a></li>
  <li><a href="#groupreduce-on-grouped-dataset" id="markdown-toc-groupreduce-on-grouped-dataset">GroupReduce on Grouped DataSet</a></li>
  <li><a href="#groupcombine-on-a-grouped-dataset" id="markdown-toc-groupcombine-on-a-grouped-dataset">GroupCombine on a Grouped DataSet</a></li>
  <li><a href="#aggregate-on-grouped-tuple-dataset" id="markdown-toc-aggregate-on-grouped-tuple-dataset">Aggregate on Grouped Tuple DataSet</a></li>
  <li><a href="#reduce-on-full-dataset" id="markdown-toc-reduce-on-full-dataset">Reduce on full DataSet</a></li>
  <li><a href="#groupreduce-on-full-dataset" id="markdown-toc-groupreduce-on-full-dataset">GroupReduce on full DataSet</a></li>
  <li><a href="#groupcombine-on-a-full-dataset" id="markdown-toc-groupcombine-on-a-full-dataset">GroupCombine on a full DataSet</a></li>
  <li><a href="#aggregate-on-full-tuple-dataset" id="markdown-toc-aggregate-on-full-tuple-dataset">Aggregate on full Tuple DataSet</a></li>
  <li><a href="#distinct" id="markdown-toc-distinct">Distinct</a></li>
  <li><a href="#join" id="markdown-toc-join">Join</a></li>
  <li><a href="#outerjoin" id="markdown-toc-outerjoin">OuterJoin</a></li>
  <li><a href="#cross" id="markdown-toc-cross">Cross</a></li>
  <li><a href="#cogroup" id="markdown-toc-cogroup">CoGroup</a></li>
  <li><a href="#union" id="markdown-toc-union">Union</a></li>
  <li><a href="#rebalance" id="markdown-toc-rebalance">Rebalance</a></li>
  <li><a href="#hash-partition" id="markdown-toc-hash-partition">Hash-Partition</a></li>
  <li><a href="#range-partition" id="markdown-toc-range-partition">Range-Partition</a></li>
  <li><a href="#sort-partition" id="markdown-toc-sort-partition">Sort Partition</a></li>
  <li><a href="#first-n" id="markdown-toc-first-n">First-n</a></li>
</ul>

<h3 id="map">Map</h3>

<p>Map transformation接收用户定义的一个map 函数， 它操作DataSet里面每个元素。
它实现1对1的映射（mapping），也就是， 一个元素会返回一个结果。</p>

<p>下面例子展示将Integer pairs的DataSet转化为Integers的DataSet：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// MapFunction that adds two integer values</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IntAdder</span> <span class="kd">implements</span> <span class="n">MapFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">map</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">in</span><span class="o">.</span><span class="na">f0</span> <span class="o">+</span> <span class="n">in</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">intPairs</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intSums</span> <span class="o">=</span> <span class="n">intPairs</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">new</span> <span class="nf">IntAdder</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">intPairs</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">intSums</span> <span class="k">=</span> <span class="n">intPairs</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">pair</span> <span class="k">=&gt;</span> <span class="n">pair</span><span class="o">.</span><span class="n">_1</span> <span class="o">+</span> <span class="n">pair</span><span class="o">.</span><span class="n">_2</span> <span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">intSums</span> <span class="o">=</span> <span class="n">intPairs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></code></pre></div>

  </div>
</div>

<h3 id="flatmap">FlatMap</h3>

<p>FlatMap transformation 接收用户定义的一个flat-map函数，它会操作DataSet的每个元素。
每一个输入的元素，flat-map会返回任意个结果。</p>

<p>The following code transforms a DataSet of text lines into a DataSet of words:</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// FlatMapFunction that tokenizes a String by whitespace characters and emits all String tokens.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tokenizer</span> <span class="kd">implements</span> <span class="n">FlatMapFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">token</span> <span class="o">:</span> <span class="n">value</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\W&quot;</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">words</span> <span class="o">=</span> <span class="n">textLines</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="k">new</span> <span class="nf">Tokenizer</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">textLines</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">words</span> <span class="k">=</span> <span class="n">textLines</span><span class="o">.</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">)</span> <span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">words</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span></code></pre></div>

  </div>
</div>

<h3 id="mappartition">MapPartition</h3>

<p>MapPartition 在一个单个程序中转化一个并行分区。 map-partition 函数从Iterable获得partition 并产生任意个结果。
每个分区的元素个数依赖于并行度（degree-of-parallelism）和前一次操作。</p>

<p>The following code transforms a DataSet of text lines into a DataSet of counts per partition:</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PartitionCounter</span> <span class="kd">implements</span> <span class="n">MapPartitionFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mapPartition</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">c</span><span class="o">++;</span>
    <span class="o">}</span>
    <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">textLines</span><span class="o">.</span><span class="na">mapPartition</span><span class="o">(</span><span class="k">new</span> <span class="nf">PartitionCounter</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">textLines</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// Some is required because the return value must be a Collection.</span>
<span class="c1">// There is an implicit conversion from Option to a Collection.</span>
<span class="k">val</span> <span class="n">counts</span> <span class="k">=</span> <span class="n">texLines</span><span class="o">.</span><span class="n">mapPartition</span> <span class="o">{</span> <span class="n">in</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">size</span><span class="o">)</span> <span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">counts</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">map_partition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)])</span></code></pre></div>

  </div>
</div>

<h3 id="filter">Filter</h3>

<p>Filter transformation接收一个用户定义的filter函数， 它操作DataSet上每一个元素。
它返回函数返回<code>true</code>的元素集合。</p>

<p>下面例子过滤掉小于0的Integers：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// FilterFunction that filters out all Integers smaller than zero.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NaturalNumberFilter</span> <span class="kd">implements</span> <span class="n">FilterFunction</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">filter</span><span class="o">(</span><span class="n">Integer</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intNumbers</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">naturalNumbers</span> <span class="o">=</span> <span class="n">intNumbers</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="k">new</span> <span class="nf">NaturalNumberFilter</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">intNumbers</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">naturalNumbers</span> <span class="k">=</span> <span class="n">intNumbers</span><span class="o">.</span><span class="n">filter</span> <span class="o">{</span> <span class="k">_</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">naturalNumbers</span> <span class="o">=</span> <span class="n">intNumbers</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></code></pre></div>

  </div>
</div>

<p><strong>注意:</strong> 
系统假设在进行判定时函数并不修改元素。 进行修改会导致错误结果。</p>

<h3 id="project-tuple-datasets-only-javapython-api-only">Project (Tuple DataSets only) (Java/Python API Only)</h3>

<p>Project transformation就是去掉或移动Tuple的字段。
<code>project(int...)</code> 函数将选择index标示的Tuple字段，并在输出Tuple定义他们的顺序。</p>

<p>Projections 不需要用户定义一个函数。</p>

<p>下面展示几种不同的Project transformation方式：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// converts Tuple3&lt;Integer, Double, String&gt; into Tuple2&lt;String, Integer&gt;</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></code></pre></div>

    <h4 id="projection-with-type-hint">Projection with Type Hint</h4>

    <p>注意， java的编译器并不能判断<code>project</code>操作的返回类型。 因此， 如果用户在<code>project</code>操作的结果上再执行其他的操作会出错。</p>

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple5</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="o">....</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple1</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">ds2</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">distinct</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></code></pre></div>

    <p>This problem can be overcome by hinting the return type of <code>project</code> operator like this:</p>

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple1</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">ds2</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.&lt;</span><span class="n">Tuple1</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="n">project</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">distinct</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">out</span> <span class="o">=</span> <span class="ow">in</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></code></pre></div>

  </div>
</div>

<h3 id="transformations-on-grouped-dataset">Transformations on Grouped DataSet</h3>

<p>reduce操作可以操作grouped的数据集。 确定用哪些key来做grouping有很多种方式：</p>

<ul>
  <li>key 表达式</li>
  <li>key选择函数（key-selector function）</li>
  <li>一个或多个字段位置key(Tuple DataSet only)</li>
  <li>Case Class 字段(Case Classes only)</li>
</ul>

<p>请查看reduce的exmaple来了解如何选择grouping key。</p>

<h3 id="reduce-on-grouped-dataset">Reduce on Grouped DataSet</h3>
<p>在grouped的DataSet执行reduce</p>

<p>A Reduce transformation that is applied on a grouped DataSet reduces each group to a single
element using a user-defined reduce function.</p>

<p>Reduce transformation接收一个用户定义的reduce函数， 这个函数操作一个grouped的DataSet， 将每个group 合并到一个单个元素。</p>

<p>对于每组输入的元素， reduce 函数连续combine 元素对（pairs of elements）到一个元素中，知道一组元素全部合并为一个元素。</p>

<h4 id="reduce-on-dataset-grouped-by-keyselector-function">Reduce on DataSet Grouped by KeySelector Function</h4>

<p>key-selector函数用于从DataSet中每个元素中解压出key值， 这个解压出来的key值用于 group 这个DataSet.</p>

<p>下面例子展示如何用key-selector函数group 一个pojo的DataSet， 并做reduce操作。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// some ordinary POJO</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WC</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">word</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
  <span class="c1">// [...]</span>
<span class="o">}</span>

<span class="c1">// ReduceFunction that sums Integer attributes of a POJO</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordCounter</span> <span class="kd">implements</span> <span class="n">ReduceFunction</span><span class="o">&lt;</span><span class="n">WC</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">WC</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">WC</span> <span class="n">in1</span><span class="o">,</span> <span class="n">WC</span> <span class="n">in2</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">WC</span><span class="o">(</span><span class="n">in1</span><span class="o">.</span><span class="na">word</span><span class="o">,</span> <span class="n">in1</span><span class="o">.</span><span class="na">count</span> <span class="o">+</span> <span class="n">in2</span><span class="o">.</span><span class="na">count</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">WC</span><span class="o">&gt;</span> <span class="n">words</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">WC</span><span class="o">&gt;</span> <span class="n">wordCounts</span> <span class="o">=</span> <span class="n">words</span>
                         <span class="c1">// DataSet grouping on field &quot;word&quot;</span>
                         <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">&quot;word&quot;</span><span class="o">)</span>
                         <span class="c1">// apply ReduceFunction on grouped DataSet</span>
                         <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="nf">WordCounter</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="c1">// some ordinary POJO</span>
<span class="k">class</span> <span class="nc">WC</span><span class="o">(</span><span class="k">val</span> <span class="n">word</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">val</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="k">this</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="c1">// [...]</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">words</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">WC</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">wordCounts</span> <span class="k">=</span> <span class="n">words</span><span class="o">.</span><span class="n">groupBy</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">word</span> <span class="o">}</span> <span class="n">reduce</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">w1</span><span class="o">,</span> <span class="n">w2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">WC</span><span class="o">(</span><span class="n">w1</span><span class="o">.</span><span class="n">word</span><span class="o">,</span> <span class="n">w1</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">w2</span><span class="o">.</span><span class="n">count</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>
  </div>
</div>

<h4 id="reduce-on-dataset-grouped-by-field-position-keys-tuple-datasets-only">Reduce on DataSet Grouped by Field Position Keys (Tuple DataSets only)</h4>

<p>对 用字段位置做group的DataSet进行reduce操作(Tuple DataSets only)</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">tuples</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">reducedTuples</span> <span class="o">=</span>
                                         <span class="n">tuples</span>
                                         <span class="c1">// group DataSet on first and second field of Tuple</span>
                                         <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
                                         <span class="c1">// apply ReduceFunction on grouped DataSet</span>
                                         <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="nf">MyTupleReducer</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">tuples</span> <span class="k">=</span> <span class="nc">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// group on the first and second Tuple field</span>
<span class="k">val</span> <span class="n">reducedTuples</span> <span class="k">=</span> <span class="n">tuples</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">reduce</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></div>

    <h4 id="reduce-on-dataset-grouped-by-case-class-fields">Reduce on DataSet grouped by Case Class Fields</h4>

    <p>当使用Case Classes时， 用户可以通过食用field的name来挑选grouping的key。</p>

    <div class="highlight"><pre><code class="language-scala"><span class="k">case</span> <span class="k">class</span> <span class="nc">MyClass</span><span class="o">(</span><span class="k">val</span> <span class="n">a</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">c</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>
<span class="k">val</span> <span class="n">tuples</span> <span class="k">=</span> <span class="nc">DataSet</span><span class="o">[</span><span class="kt">MyClass</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// group on the first and second field</span>
<span class="k">val</span> <span class="n">reducedTuples</span> <span class="k">=</span> <span class="n">tuples</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="s">&quot;b&quot;</span><span class="o">).</span><span class="n">reduce</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">reducedTuples</span> <span class="o">=</span> <span class="n">tuples</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span></code></pre></div>

  </div>
</div>

<h3 id="groupreduce-on-grouped-dataset">GroupReduce on Grouped DataSet</h3>
<p>对一个grouped的DataSet进行GroupReduce</p>

<p>GroupReduce transformation 接收一个用户自定义的group－reduce函数， 这个函数对grouped DataSet上每一个group进行操作。 
它和<em>Reduce</em>的区别在于， group－reduce函数是一次拿到一个完整的group。
这个函数被一个含有一个group上所有元素的Iterable调用， 并返回任意个数的result elements。</p>

<h4 id="groupreduce-on-dataset-grouped-by-field-position-keys-tuple-datasets-only">GroupReduce on DataSet Grouped by Field Position Keys (Tuple DataSets only)</h4>

<p>下面例子展示 如何将一个DataSet中重复的string给过滤掉， 这个DataSet是由integer来grouped。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DistinctReduce</span>
         <span class="kd">implements</span> <span class="n">GroupReduceFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">in</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">uniqStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// add all strings of the group to the set</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">f0</span><span class="o">;</span>
      <span class="n">uniqStrings</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">f1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// emit all unique strings.</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">uniqStrings</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;(</span><span class="n">key</span><span class="o">,</span> <span class="n">s</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span>
                           <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>            <span class="c1">// group DataSet by the first tuple field</span>
                           <span class="o">.</span><span class="na">reduceGroup</span><span class="o">(</span><span class="k">new</span> <span class="nf">DistinctReduce</span><span class="o">());</span>  <span class="c1">// apply GroupReduceFunction</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">reduceGroup</span> <span class="o">{</span>
      <span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)])</span> <span class="k">=&gt;</span>
        <span class="n">in</span><span class="o">.</span><span class="n">toSet</span> <span class="n">foreach</span> <span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">)</span>
    <span class="o">}</span></code></pre></div>

    <h4 id="groupreduce-on-dataset-grouped-by-case-class-fields">GroupReduce on DataSet Grouped by Case Class Fields</h4>

    <p>类似<em>Reduce</em> transformations中Case Class fields 工作方式。</p>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="k">class</span> <span class="nc">DistinctReduce</span><span class="p">(</span><span class="n">GroupReduceFunction</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">collector</span><span class="p">):</span>
     <span class="n">dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
       <span class="n">dic</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
       <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

 <span class="n">output</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reduce_group</span><span class="p">(</span><span class="n">DistinctReduce</span><span class="p">())</span></code></pre></div>

  </div>
</div>

<h4 id="groupreduce-on-dataset-grouped-by-keyselector-function">GroupReduce on DataSet Grouped by KeySelector Function</h4>

<p>类似<em>Reduce</em> transformations中key-selector  工作方式。</p>

<h4 id="groupreduce-on-sorted-groups">GroupReduce on sorted groups</h4>

<p>group-reduce 函数通过Iterable来访问一个group的所有元素。 可选的是， 这个Iterable可以按照某种顺序在一个group上对所有元素进行排序。 
很多情况下， 这样可以减少group-reduce的复杂度和提供效率。</p>

<p>The following code shows another example how to remove duplicate Strings in a DataSet grouped by an Integer and sorted by String.</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// GroupReduceFunction that removes consecutive identical elements</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DistinctReduce</span>
         <span class="kd">implements</span> <span class="n">GroupReduceFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">in</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">comp</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">f0</span><span class="o">;</span>
      <span class="n">String</span> <span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>

      <span class="c1">// check if strings are different</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">com</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">next</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">comp</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;(</span><span class="n">key</span><span class="o">,</span> <span class="n">next</span><span class="o">));</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span>
                         <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>                         <span class="c1">// group DataSet by first field</span>
                         <span class="o">.</span><span class="na">sortGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Order</span><span class="o">.</span><span class="na">ASCENDING</span><span class="o">)</span>      <span class="c1">// sort groups on second tuple field</span>
                         <span class="o">.</span><span class="na">reduceGroup</span><span class="o">(</span><span class="k">new</span> <span class="nf">DistinctReduce</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">sortGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Order</span><span class="o">.</span><span class="nc">ASCENDING</span><span class="o">).</span><span class="n">reduceGroup</span> <span class="o">{</span>
      <span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)])</span> <span class="k">=&gt;</span>
        <span class="k">var</span> <span class="n">prev</span><span class="k">:</span> <span class="o">(</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="kc">null</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">t</span> <span class="k">&lt;-</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">prev</span> <span class="o">!=</span> <span class="n">t</span><span class="o">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="k">class</span> <span class="nc">DistinctReduce</span><span class="p">(</span><span class="n">GroupReduceFunction</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">collector</span><span class="p">):</span>
     <span class="n">dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
       <span class="n">dic</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
       <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

 <span class="n">output</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Order</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)</span><span class="o">.</span><span class="n">reduce_group</span><span class="p">(</span><span class="n">DistinctReduce</span><span class="p">())</span></code></pre></div>

  </div>
</div>

<p><strong>注意</strong> GroupSort可以在reduce操作前自由调用， 当在一个可以sort的执行策略的基础上进行grouping时。</p>

<h4 id="combinable-groupreducefunctions">Combinable GroupReduceFunctions</h4>

<p>和reduce 函数相比， 一个group-reduce并不做潜在combine操作。 如果想要在group-reduce 函数的基础上做combine操作，
需要调用<code>GroupCombineFunction</code>接口。</p>

<p><strong>重要</strong>： <code>GroupCombineFunction</code>接口的输入和输出类型必须等同于<code>GroupReduceFunction</code>函数的输入类型：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// Combinable GroupReduceFunction that computes a sum.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCombinableGroupReducer</span> <span class="kd">implements</span>
  <span class="n">GroupReduceFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">String</span><span class="o">&gt;,</span>
  <span class="n">GroupCombineFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> 
<span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">in</span><span class="o">,</span>
                     <span class="n">Collector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">curr</span> <span class="o">:</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="na">f0</span><span class="o">;</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="n">curr</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// concat key and sum and emit</span>
    <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">sum</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">combine</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">in</span><span class="o">,</span>
                      <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">curr</span> <span class="o">:</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="na">f0</span><span class="o">;</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="n">curr</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// emit tuple with key and sum</span>
    <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="n">key</span><span class="o">,</span> <span class="n">sum</span><span class="o">));</span> 
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="c1">// Combinable GroupReduceFunction that computes two sums.</span>
<span class="k">class</span> <span class="nc">MyCombinableGroupReducer</span>
  <span class="k">extends</span> <span class="nc">GroupReduceFunction</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)</span>, <span class="kt">String</span><span class="o">]</span>
  <span class="k">with</span> <span class="nc">GroupCombineFunction</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)</span>, <span class="o">(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span>
<span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">reduce</span><span class="o">(</span>
    <span class="n">in</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)],</span>
    <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="o">{</span>
    <span class="k">val</span> <span class="n">r</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span>
      <span class="n">in</span><span class="o">.</span><span class="n">asScala</span><span class="o">.</span><span class="n">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_2</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">)</span>
    <span class="c1">// concat key and sum and emit</span>
    <span class="n">out</span><span class="o">.</span><span class="n">collect</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">_1</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">combine</span><span class="o">(</span>
    <span class="n">in</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)],</span>
    <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="o">{</span>
    <span class="k">val</span> <span class="n">r</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span>
      <span class="n">in</span><span class="o">.</span><span class="n">asScala</span><span class="o">.</span><span class="n">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_2</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">)</span>
    <span class="c1">// emit tuple with key and sum</span>
    <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="k">class</span> <span class="nc">GroupReduce</span><span class="p">(</span><span class="n">GroupReduceFunction</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">collector</span><span class="p">):</span>
     <span class="n">key</span><span class="p">,</span> <span class="n">int_sum</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
       <span class="n">int_sum</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
     <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">int_sum</span><span class="p">))</span>

   <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">collector</span><span class="p">):</span>
     <span class="n">key</span><span class="p">,</span> <span class="n">int_sum</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
       <span class="n">int_sum</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
     <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">int_sum</span><span class="p">))</span>

<span class="n">data</span><span class="o">.</span><span class="n">reduce_group</span><span class="p">(</span><span class="n">GroupReduce</span><span class="p">(),</span> <span class="n">combinable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>

  </div>
</div>

<h3 id="groupcombine-on-a-grouped-dataset">GroupCombine on a Grouped DataSet</h3>

<p>GroupCombine transformation 是在GroupReduceFunction上进行combine操作的常见方式。
通常情况下，它允许combine 输入类型<code>I</code>到一个任意输出类型<code>O</code>。然而， GroupReduce的combine操作
仅仅允许输入类型是<code>I</code>到输出类型<code>I</code>。 这是因为GroupReduceFunction上的reduce操作期望输入<code>I</code></p>

<p>在一些应用中， 在执行一个额外的transformations前，期望combine一个DataSet到一个中间format。
可以通过CombineGroup transformation用一个很小的代价来达到这种目的。</p>

<p><strong>注意</strong> 在grouped 的DataSet上GroupCombine是在内存中执行， 用一种贪婪的策略， 
这个策略有可能不是一次性处理所有数据，而是分阶段来完成。 它（GroupCombine）同样在单独的partition上执行，
这些单独的partition没有像GroupReduce transformation这样的数据交换操作。 这会导致部分结果。</p>

<p>下面例子展示使用CombineGroup transformation来完成一种可选wordcount的实现。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="o">[..]</span> <span class="c1">// The words received as input</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">combinedWords</span> <span class="o">=</span> <span class="n">input</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// group identical words</span>
  <span class="o">.</span><span class="na">combineGroup</span><span class="o">(</span><span class="k">new</span> <span class="n">GroupCombineFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">combine</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">words</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;)</span> <span class="o">{</span> <span class="c1">// combine</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">word</span> <span class="o">:</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">count</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="nf">Tuple2</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">count</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">});</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">combinedWords</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>                             <span class="c1">// group by words again</span>
  <span class="o">.</span><span class="na">reduceGroup</span><span class="o">(</span><span class="k">new</span> <span class="nf">GroupReduceFunction</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// group reduce with full data exchange</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">word</span> <span class="o">:</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">count</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="nf">Tuple2</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">count</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">});</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">..</span><span class="o">]</span> <span class="c1">// The words received as input</span>

<span class="k">val</span> <span class="n">combinedWords</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="n">input</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
  <span class="o">.</span><span class="n">combineGroup</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">words</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)])</span> <span class="k">=&gt;</span>
        <span class="k">var</span> <span class="n">count</span> <span class="k">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">word</span> <span class="k">&lt;-</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">count</span><span class="o">++</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">output</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="n">combinedWords</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
  <span class="o">.</span><span class="n">reduceGroup</span> <span class="o">{</span>
    <span class="o">(</span><span class="n">words</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)])</span> <span class="k">=&gt;</span>
        <span class="k">var</span> <span class="n">count</span> <span class="k">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="o">((</span><span class="n">word</span><span class="o">,</span> <span class="nc">Int</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">count</span><span class="o">++</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

  </div>
</div>

<p>上例展示GroupCombine如何在GroupReduce之前combine words. 上例只是展示这种概念。
注意，在combine步骤中改变DataSet的类型通常需要在GroupReduce之前一个额外的Map transformation。</p>

<h3 id="aggregate-on-grouped-tuple-dataset">Aggregate on Grouped Tuple DataSet</h3>

<p>下面有些常用的聚合操作。 fink提供一些内置的聚合操作：</p>

<ul>
  <li>Sum,</li>
  <li>Min, and</li>
  <li>Max.</li>
</ul>

<p>仅仅只能在Tuple DataSet上进行聚会转换， 并且基于field postition 的key做grouping。</p>

<p>下面例子展示如何在field positition key上做group的DataSet上执行聚合操作：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span>
                                   <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>        <span class="c1">// group DataSet on second field</span>
                                   <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">SUM</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// compute sum of the first field</span>
                                   <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">MIN</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>      <span class="c1">// compute minimum of the third field</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">aggregate</span><span class="o">(</span><span class="nc">SUM</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="n">and</span><span class="o">(</span><span class="nc">MIN</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<p>如果想要在一个DataSet同时执行多个聚合操作， 需要在上一个聚合后执行<code>.and()</code>函数， 比如<code>.aggregate(SUM, 0).and(MIN, 2)</code>表示对field 0进行sum并且在原始DataSet的field 2上执行minimum。
相反， <code>.aggregate(SUM, 0).aggregate(MIN, 2)</code>表示一个聚合基于另外一个聚合的结果， 
<code>.aggregate(SUM, 0).aggregate(MIN, 2)</code>表示在计算filed 0的sum 后计算field 2的最小值。</p>

<p><strong>注意</strong> 聚合函数以后会扩展</p>

<h3 id="reduce-on-full-dataset">Reduce on full DataSet</h3>
<p>全数据集进行reduce</p>

<p>Reduce transformation 使用一个用户定义的reduce函数， 这个函数操作DataSet所有元素。
这个reduce函数连续combine 元素对到一个元素，直到只剩下一个元素。</p>

<p>下面代码展示如何sum 一个Integer DataSet：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// ReduceFunction that sums Integers</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IntSummer</span> <span class="kd">implements</span> <span class="n">ReduceFunction</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Integer</span> <span class="n">num1</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">num2</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">num1</span> <span class="o">+</span> <span class="n">num2</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intNumbers</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">intNumbers</span><span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="nf">IntSummer</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">intNumbers</span> <span class="k">=</span> <span class="n">env</span><span class="o">.</span><span class="n">fromElements</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
<span class="k">val</span> <span class="n">sum</span> <span class="k">=</span> <span class="n">intNumbers</span><span class="o">.</span><span class="n">reduce</span> <span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">intNumbers</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">from_elements</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
 <span class="nb">sum</span> <span class="o">=</span> <span class="n">intNumbers</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span></code></pre></div>

  </div>
</div>

<p>全数据集上的reduce操作意味着最终的reduce操作不能并行来执行。 然而， 一个reduce函数自动combinable，因此一个reduce转换多数情况下不会限制scalability</p>

<h3 id="groupreduce-on-full-dataset">GroupReduce on full DataSet</h3>
<p>全数据集上GroupReduce</p>

<p>GroupReduce transformation 接收一个用户自定义的group－reduce函数， 这个函数对 DataSet上每一个元素进行操作。 
这个函数group－reduce迭代DataSet上所有的元素， 并返回任意个数的result elements。</p>

<p>The following example shows how to apply a GroupReduce transformation on a full DataSet:</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// apply a (preferably combinable) GroupReduceFunction to a DataSet</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">reduceGroup</span><span class="o">(</span><span class="k">new</span> <span class="nf">MyGroupReducer</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">reduceGroup</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyGroupReducer</span><span class="o">())</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">output</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reduce_group</span><span class="p">(</span><span class="n">MyGroupReducer</span><span class="p">())</span></code></pre></div>

  </div>
</div>

<p><strong>注意</strong> 如果group-reduce不是combinable， 在全数据集上的一个GroupReduce不能被并行执行。
因此， 它是一个集中计算操作。 阅读 上面章节”Combinable GroupReduceFunctions”， 了解如何实现一个combinable的group-reduce函数。</p>

<h3 id="groupcombine-on-a-full-dataset">GroupCombine on a full DataSet</h3>
<p>在全数据集上执行GroupCombine</p>

<p>在全数据集上执行GroupCombine类似在一个grouped的DataSet上执行GroupCombine。
数据被partition到所有的node上， 然后用一种贪婪的方式combine(仅仅放到内存中的数据马上combine)。</p>

<h3 id="aggregate-on-full-tuple-dataset">Aggregate on full Tuple DataSet</h3>
<p>在全数据集上聚合</p>

<p>flink内建如下的常用聚合操作：</p>

<ul>
  <li>Sum,</li>
  <li>Min, and</li>
  <li>Max.</li>
</ul>

<p>聚合转换只能在Tuple DataSet上使用。</p>

<p>下面代码展示如何在全数据集上执行聚合转换：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span>
                                     <span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">SUM</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>    <span class="c1">// compute sum of the first field</span>
                                     <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">MIN</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>    <span class="c1">// compute minimum of the second field</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">aggregate</span><span class="o">(</span><span class="nc">SUM</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="n">and</span><span class="o">(</span><span class="nc">MIN</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<p><strong>注意</strong> 以后会支持新的聚合函数。</p>

<h3 id="distinct">Distinct</h3>

<p>Distinct 转换 distinct source DataSet上所有元素(过滤掉重复的元素)：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">distinct</span><span class="o">();</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">distinct</span><span class="o">()</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<p>可以设置如何在一个数据集上distinct元素的方式：</p>
<ul>
  <li>一个或多个field 位置keys(仅仅Tuple DataSets)</li>
  <li>一个key-selector函数</li>
  <li>一个key表达式</li>
</ul>

<h4 id="distinct-with-field-position-keys">Distinct with field position keys</h4>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">2</span><span class="o">);</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">Double</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">distinct</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<h4 id="distinct-with-keyselector-function">Distinct with KeySelector function</h4>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbsSelector</span> <span class="kd">implements</span> <span class="n">KeySelector</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getKey</span><span class="o">(</span><span class="n">Integer</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    	<span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="k">new</span> <span class="nf">AbsSelector</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">distinct</span> <span class="o">{</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nc">Math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">x</span><span class="o">)}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<h4 id="distinct-with-key-expression">Distinct with key expression</h4>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// some ordinary POJO</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomType</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">aName</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">aNumber</span><span class="o">;</span>
  <span class="c1">// [...]</span>
<span class="o">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">CustomType</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">CustomType</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="s">&quot;aName&quot;</span><span class="o">,</span> <span class="s">&quot;aNumber&quot;</span><span class="o">);</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="c1">// some ordinary POJO</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">CustomType</span><span class="o">(</span><span class="n">aName</span> <span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">aNumber</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>

<span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">CustomType</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">distinct</span><span class="o">(</span><span class="s">&quot;aName&quot;</span><span class="o">,</span> <span class="s">&quot;aNumber&quot;</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<p>可以用通配符来表示使用所有的字段：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">CustomType</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">CustomType</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="s">&quot;*&quot;</span><span class="o">);</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="c1">// some ordinary POJO</span>
<span class="k">val</span> <span class="n">input</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">CustomType</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">input</span><span class="o">.</span><span class="n">distinct</span><span class="o">(</span><span class="s">&quot;_&quot;</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<h3 id="join">Join</h3>

<p>join 转换join 2个数据集到一个数据集。 2个数据集上的元素在一个或多个key上join起来， 可以通过下面方式来选择用于join的key：</p>

<ul>
  <li>一个或多个field 位置keys(仅仅Tuple DataSets)</li>
  <li>一个key-selector函数</li>
  <li>一个key表达式</li>
  <li>Case Class 字段</li>
</ul>

<p>下面展示几种join转换的方式：</p>

<h4 id="default-join-join-into-tuple2">Default Join (Join into Tuple2)</h4>

<p>默认join 转换产生一个新的Tuple带2个字段的数据集。 tuple第一个字段放第一个数据集的的join 元素， tuple第二个字段放置第二个数据集匹配的元素。</p>

<p>下例展示使用field 位置key的方式执行默认join转换：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span> <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span> <span class="kd">public</span> <span class="kt">int</span> <span class="n">zip</span><span class="o">;</span> <span class="o">}</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Store</span> <span class="o">{</span> <span class="kd">public</span> <span class="n">Manager</span> <span class="n">mgr</span><span class="o">;</span> <span class="kd">public</span> <span class="kt">int</span> <span class="n">zip</span><span class="o">;</span> <span class="o">}</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Store</span><span class="o">&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// result dataset is typed as Tuple2</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Store</span><span class="o">&gt;&gt;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;zip&quot;</span><span class="o">)</span>       <span class="c1">// key of the first input (users)</span>
                           <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;zip&quot;</span><span class="o">);</span>    <span class="c1">// key of the second input (stores)</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">input2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Double</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">input2</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="n">result</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></code></pre></div>

  </div>
</div>

<h4 id="join-with-join-function">Join with Join Function</h4>
<p>用join函数来进行join</p>

<p>A Join transformation can also call a user-defined join function to process joining tuples.
A join function receives one element of the first input DataSet and one element of the second input DataSet and returns exactly one element.
一个join转换可以使用自定义的join函数来join tuples。
这个join函数接受第一个数据集的一个元素和第二个数据集的元素，然后返回仅仅一个元素。</p>

<p>下例展示 对一个自定义java对象数据集和Tuple数据集上通过key－selector函数来执行join操作，以及如何使用一个用户自定义的join函数：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// some POJO</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Rating</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">category</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">points</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Join function that joins a custom POJO with a Tuple</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointWeighter</span>
         <span class="kd">implements</span> <span class="n">JoinFunction</span><span class="o">&lt;</span><span class="n">Rating</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="nf">join</span><span class="o">(</span><span class="n">Rating</span> <span class="n">rating</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">weight</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// multiply the points and rating and construct a new output tuple</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;(</span><span class="n">rating</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">rating</span><span class="o">.</span><span class="na">points</span> <span class="o">*</span> <span class="n">weight</span><span class="o">.</span><span class="na">f1</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Rating</span><span class="o">&gt;</span> <span class="n">ratings</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">weights</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span>
            <span class="n">weightedRatings</span> <span class="o">=</span>
            <span class="n">ratings</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">weights</span><span class="o">)</span>

                   <span class="c1">// key of the first input</span>
                   <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;category&quot;</span><span class="o">)</span>

                   <span class="c1">// key of the second input</span>
                   <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;f0&quot;</span><span class="o">)</span>

                   <span class="c1">// applying the JoinFunction on joining pairs</span>
                   <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="nf">PointWeighter</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">case</span> <span class="k">class</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">points</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="n">ratings</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Ratings</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">weights</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="k">val</span> <span class="n">weightedRatings</span> <span class="k">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">weights</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;category&quot;</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">rating</span><span class="o">,</span> <span class="n">weight</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">rating</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">rating</span><span class="o">.</span><span class="n">points</span> <span class="o">*</span> <span class="n">weight</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="k">class</span> <span class="nc">PointWeighter</span><span class="p">(</span><span class="n">JoinFunction</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rating</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
     <span class="k">return</span> <span class="p">(</span><span class="n">rating</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rating</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       <span class="k">if</span> <span class="n">value1</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>

 <span class="n">weightedRatings</span> <span class="o">=</span>
   <span class="n">ratings</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span> \
   <span class="k">with</span><span class="p">(</span><span class="n">new</span> <span class="n">PointWeighter</span><span class="p">());</span></code></pre></div>

  </div>
</div>

<h4 id="join-with-flat-join-function">Join with Flat-Join Function</h4>
<p>用flat－join函数进行join</p>

<p>类似Map and FlatMap, FlatJoin 行为类似join，但返回不是一个元素，可以返回0个，1个，或多个元素。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointWeighter</span>
         <span class="kd">implements</span> <span class="n">FlatJoinFunction</span><span class="o">&lt;</span><span class="n">Rating</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="n">Rating</span> <span class="n">rating</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">weight</span><span class="o">,</span>
	  <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">weight</span><span class="o">.</span><span class="na">f1</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;(</span><span class="n">rating</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">rating</span><span class="o">.</span><span class="na">points</span> <span class="o">*</span> <span class="n">weight</span><span class="o">.</span><span class="na">f1</span><span class="o">));</span>
	<span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span>
            <span class="n">weightedRatings</span> <span class="o">=</span>
            <span class="n">ratings</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">weights</span><span class="o">)</span> <span class="c1">// [...]</span></code></pre></div>

    <h4 id="join-with-projection-javapython-only">Join with Projection (Java/Python Only)</h4>
    <p>用投射(projection)进行join（仅仅java／python）， 意味着返回集是经过挑选的字段。</p>

    <p>下例将展示使用projection join：</p>

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Byte</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple4</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">,</span> <span class="n">Byte</span><span class="o">&gt;</span>
            <span class="n">result</span> <span class="o">=</span>
            <span class="n">input1</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                  <span class="c1">// key definition on first DataSet using a field position key</span>
                  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                  <span class="c1">// key definition of second DataSet using a field position key</span>
                  <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                  <span class="c1">// select and reorder fields of matching tuples</span>
                  <span class="o">.</span><span class="na">projectFirst</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">2</span><span class="o">).</span><span class="na">projectSecond</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">projectFirst</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span></code></pre></div>

    <p><code>projectFirst(int...)</code> 和 <code>projectSecond(int...)</code> 挑选第一个数据集的字段以及joined第二个数据集的字段， 他们都会被打包入输出tuple。 index的顺序定义了输出tuple中字段的顺序。
The join projection works also for non-Tuple DataSets. In this case, <code>projectFirst()</code> or <code>projectSecond()</code> must be called without arguments to add a joined element to the output Tuple.
对一个非Tuple的数据集， join projection同样可以工作， 这种情况下， 必须无参数调用<code>projectFirst()</code> or <code>projectSecond()</code>来增加一个joined 元素到输出tuple里面。</p>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">case</span> <span class="k">class</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">points</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="n">ratings</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Ratings</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">weights</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="k">val</span> <span class="n">weightedRatings</span> <span class="k">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">weights</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;category&quot;</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">rating</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=&gt;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">weight</span><span class="o">.</span><span class="n">_2</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="o">)</span> <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">left</span><span class="o">.</span><span class="n">points</span> <span class="o">*</span> <span class="n">right</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <h4 id="join-with-projection-javapython-only-1">Join with Projection (Java/Python Only)</h4>

    <p>用投射(projection)进行join（仅仅java／python）， 意味着返回集是经过挑选的字段。</p>

    <p>下例将展示使用projection join：</p>

    <div class="highlight"><pre><code class="language-python"> <span class="n">result</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">project_first</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">project_second</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">project_first</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></code></pre></div>

    <p><code>projectFirst(int...)</code> 和 <code>projectSecond(int...)</code> 挑选第一个数据集的字段以及joined第二个数据集的字段， 他们都会被打包入输出tuple。 index的顺序定义了输出tuple中字段的顺序。
The join projection works also for non-Tuple DataSets. In this case, <code>projectFirst()</code> or <code>projectSecond()</code> must be called without arguments to add a joined element to the output Tuple.
对一个非Tuple的数据集， join projection同样可以工作， 这种情况下， 必须无参数调用<code>projectFirst()</code> or <code>projectSecond()</code>来增加一个joined 元素到输出tuple里面。</p>

  </div>
</div>

<h4 id="join-with-dataset-size-hint">Join with DataSet Size Hint</h4>
<p>带数据集大小提示的join</p>

<p>为了帮助优化器选择正确的执行策略， 用户可以提示join的数据集的大小：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;&gt;</span>
            <span class="n">result1</span> <span class="o">=</span>
            <span class="c1">// hint that the second DataSet is very small</span>
            <span class="n">input1</span><span class="o">.</span><span class="na">joinWithTiny</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;&gt;</span>
            <span class="n">result2</span> <span class="o">=</span>
            <span class="c1">// hint that the second DataSet is very large</span>
            <span class="n">input1</span><span class="o">.</span><span class="na">joinWithHuge</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">input2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="c1">// hint that the second DataSet is very small</span>
<span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">joinWithTiny</span><span class="o">(</span><span class="n">input2</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>

<span class="c1">// hint that the second DataSet is very large</span>
<span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">joinWithHuge</span><span class="o">(</span><span class="n">input2</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"> <span class="c">#hint that the second DataSet is very small</span>
 <span class="n">result1</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">join_with_tiny</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

 <span class="c">#hint that the second DataSet is very large</span>
 <span class="n">result1</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">join_with_huge</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>

  </div>
</div>

<h4 id="join-algorithm-hints">Join Algorithm Hints</h4>
<p>join算法提示</p>

<p>flink runtime可以用很多种方式进行join， 每种方式在不同的环境下结果不一样。 系统会自动选择一种合理的方式， 
但允许用户手动选择一种策略， 这种情况下， 用户可以选择一种指定的方式进行join。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="o">&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">AnotherType</span><span class="o">&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="o">,</span> <span class="n">AnotherType</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
      <span class="n">input1</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">input2</span><span class="o">,</span> <span class="n">JoinHint</span><span class="o">.</span><span class="na">BROADCAST_HASH_FIRST</span><span class="o">)</span>
            <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">);</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">SomeType</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">input2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">AnotherType</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="c1">// hint that the second DataSet is very small</span>
<span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">input2</span><span class="o">,</span> <span class="nc">JoinHint</span><span class="o">.</span><span class="nc">BROADCAST_HASH_FIRST</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<p>有如下提示：</p>

<ul>
  <li>
    <p><code>OPTIMIZER_CHOOSES</code>: 等价于没有提示， 让系统做选择。</p>
  </li>
  <li>
    <p><code>BROADCAST_HASH_FIRST</code>: 广播第一个数据集并根据它来创建一张hash table， 这个hash table 会被第二个数据集来调查（probe）。 这种策略适合第一个数据集比较小。</p>
  </li>
  <li>
    <p><code>BROADCAST_HASH_SECOND</code>: 广播第二个数据集并根据它来创建一张hash table， 这个hash table 会被第一个数据集来调查（probe）。 这种策略适合第二个数据集比较小。</p>
  </li>
  <li>
    <p><code>REPARTITION_HASH_FIRST</code>: 系统分区（shuffles）每一个输入（除非这个输入已经被分区）并根据第一个数据集创建一张hash table。 
这种策略适合第一个数据集比第二个数据集小，但2个数据集仍然很大。
<em>注意</em>： 这是默认的fallback策略， 当无法评估大小时并且没有预先存在的parition和可以重复使用的sort－order。</p>
  </li>
  <li>
    <p><code>REPARTITION_HASH_SECOND</code>: 系统分区（shuffles）每一个输入（除非这个输入已经被分区）并根据第二个数据集创建一张hash table。 
这种策略适合第一个数据集比第二个数据集大，但2个数据集仍然很大。</p>
  </li>
  <li>
    <p><code>REPARTITION_SORT_MERGE</code>: 系统分区（shuffles）每一个输入（除非这个输入已经被分区）并对每个数据集进行排序（除非它已经排序了）
2个数据集通过merge 排序的数据集， 这种策略非常适合，当一个或2个数据集都已经排好序。</p>
  </li>
</ul>

<h3 id="outerjoin">OuterJoin</h3>

<p>Outerjoin 转换对2个数据集执行一个left／righ／full outer join。 外部join类似普通的inner join， 并创建在key上相等的所有pair。 除此之外， “outer” 边（left／right／在full时的2边）的纪录被保留当没有找到另外一边对应的key时。 匹配的pair(或者一个有元素，另外一个为<code>null</code>)输入给<code>JoinFunction</code> 函数，
这个函数将元素pair转化为一个元素，对于<code>FlatJoinFunction</code>函数， 它则转化pair为任意多个元素。</p>

<p>通过下面的方式来选择key：</p>

<ul>
  <li>一个或多个field 位置keys(仅仅Tuple DataSets)</li>
  <li>一个key-selector函数</li>
  <li>一个key表达式</li>
  <li>Case Class 字段</li>
</ul>

<p><strong>仅仅Java and Scala DataSet API 支持OuterJoins.</strong></p>

<h4 id="outerjoin-with-join-function">OuterJoin with Join Function</h4>
<p>带join函数的outerjoin</p>

<p>OuterJoin 转换调用用户自定义的join函数来处理joining的tuples。
这个join的函数接受第一个数据集的一个元素和第二个数据集的一个元素， 然后仅仅返回一个元素。 
依赖outer join的类型（left, right, full）, 2个输入元素之一可以是<code>null</code>。</p>

<p>下例对一个自定义java对象的数据集 left outer join一个tuple数据集， 用key－selector函数来选择key， 并展示如何使用用户自定义的join函数：</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="c1">// some POJO</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Rating</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">category</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">points</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Join function that joins a custom POJO with a Tuple</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointAssigner</span>
         <span class="kd">implements</span> <span class="n">JoinFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span> <span class="n">Rating</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">join</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">movie</span><span class="o">,</span> <span class="n">Rating</span> <span class="n">rating</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Assigns the rating points to the movie.</span>
    <span class="c1">// NOTE: rating might be null</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;(</span><span class="n">movie</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">rating</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">rating</span><span class="o">.</span><span class="na">points</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">movies</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Rating</span><span class="o">&gt;</span> <span class="n">ratings</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span>
            <span class="n">moviesWithPoints</span> <span class="o">=</span>
            <span class="n">movies</span><span class="o">.</span><span class="na">leftOuterJoin</span><span class="o">(</span><span class="n">ratings</span><span class="o">)</span>

                   <span class="c1">// key of the first input</span>
                   <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;f0&quot;</span><span class="o">)</span>

                   <span class="c1">// key of the second input</span>
                   <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span>

                   <span class="c1">// applying the JoinFunction on joining pairs</span>
                   <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="nf">PointAssigner</span><span class="o">());</span></code></pre></div>

  </div>
  <div data-lang="scala">

    <div class="highlight"><pre><code class="language-scala"><span class="k">case</span> <span class="k">class</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">points</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="n">movies</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">ratings</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Ratings</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="k">val</span> <span class="n">moviesWithPoints</span> <span class="k">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">leftOuterJoin</span><span class="o">(</span><span class="n">ratings</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">movie</span><span class="o">,</span> <span class="n">rating</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">movie</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">rating</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">rating</span><span class="o">.</span><span class="n">points</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

  </div>
  <div data-lang="python">

    <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

  </div>
</div>

<h4 id="outerjoin-with-flat-join-function">OuterJoin with Flat-Join Function</h4>

<p>类似Map and FlatMap, 带flat－join函数的outerjoin 类似outjoin转换， 但返回的不是一个元素， 它可以返回0个，1个或多个元素。</p>

<div class="codetabs">
  <div data-lang="java">

    <div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointAssigner</span>
         <span class="kd">implements</span> <span class="n">FlatJoinFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span> <span class="n">Rating</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">movie</span><span class="o">,</span> <span class="n">Rating</span> <span class="n">rating</span>
    <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">rating</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;(</span><span class="n">movie</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">rating</span><span class="o">.</span><span class="na">points</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;(</span><span class="n">movie</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">rating</span><span class="o">.</span><span class="na">points</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// do not emit</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span>
            <span class="n">moviesWithPoints</span> <span class="o">=</span>
            <span class="n">movies</span><span class="o">.</span><span class="na">leftOuterJoin</span><span class="o">(</span><span class="n">ratings</span><span class="o">)</span> <span class="c1">// [...]</span></code></pre></div>

    <h4 id="join-algorithm-hints">Join Algorithm Hints</h4>

    <p>flink runtime可以用很多种方式进行join， 每种方式在不同的情况下结果不一样。 系统会自动选择一种合理的方式， 
但允许用户手动选择一种策略， 这种情况下， 用户可以选择一种指定的方式进行join。</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="o">&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">AnotherType</span><span class="o">&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="o">,</span> <span class="n">AnotherType</span><span class="o">&gt;</span> <span class="n">result1</span> <span class="o">=</span>
      <span class="n">input1</span><span class="o">.</span><span class="na">leftOuterJoin</span><span class="o">(</span><span class="n">input2</span><span class="o">,</span> <span class="n">JoinHint</span><span class="o">.</span><span class="na">REPARTITION_SORT_MERGE</span><span class="o">)</span>
            <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">);</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="o">,</span> <span class="n">AnotherType</span><span class="o">&gt;</span> <span class="n">result2</span> <span class="o">=</span>
      <span class="n">input1</span><span class="o">.</span><span class="na">rightOuterJoin</span><span class="o">(</span><span class="n">input2</span><span class="o">,</span> <span class="n">JoinHint</span><span class="o">.</span><span class="na">BROADCAST_HASH_FIRST</span><span class="o">)</span>
            <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">);</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">SomeType</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">input2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">AnotherType</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="c1">// hint that the second DataSet is very small</span>
<span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">leftOuterJoin</span><span class="o">(</span><span class="n">input2</span><span class="o">,</span> <span class="nc">JoinHint</span><span class="o">.</span><span class="nc">REPARTITION_SORT_MERGE</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">result2</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">rightOuterJoin</span><span class="o">(</span><span class="n">input2</span><span class="o">,</span> <span class="nc">JoinHint</span><span class="o">.</span><span class="nc">BROADCAST_HASH_FIRST</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

      </div>
    </div>

    <p>The following hints are available.</p>

    <ul>
      <li>
        <p><code>OPTIMIZER_CHOOSES</code>: 等价于没有提示， 让系统做选择。</p>
      </li>
      <li>
        <p><code>BROADCAST_HASH_FIRST</code>: 广播第一个数据集并根据它来创建一张hash table， 这个hash table 会被第二个数据集来调查（probe）。 这种策略适合第一个数据集比较小。</p>
      </li>
      <li>
        <p><code>BROADCAST_HASH_SECOND</code>: 广播第二个数据集并根据它来创建一张hash table， 这个hash table 会被第一个数据集来调查（probe）。 这种策略适合第二个数据集比较小。</p>
      </li>
      <li>
        <p><code>REPARTITION_HASH_FIRST</code>: 系统分区（shuffles）每一个输入（除非这个输入已经被分区）并根据第一个数据集创建一张hash table。 
这种策略适合第一个数据集比第二个数据集小，但2个数据集仍然很大。</p>
      </li>
      <li>
        <p><code>REPARTITION_HASH_SECOND</code>: 系统分区（shuffles）每一个输入（除非这个输入已经被分区）并根据第二个数据集创建一张hash table。 
这种策略适合第一个数据集比第二个数据集大，但2个数据集仍然很大。</p>
      </li>
      <li>
        <p><code>REPARTITION_SORT_MERGE</code>: 系统分区（shuffles）每一个输入（除非这个输入已经被分区）并对每个数据集进行排序（除非它已经排序了）
2个数据集通过merge 排序的数据集， 这种策略非常适合，当一个或2个数据集都已经排好序。</p>
      </li>
    </ul>

    <p>** 注意 ** : 每一种join类型并不是支持所有的执行策略：</p>

    <ul>
      <li><code>LeftOuterJoin</code> supports:
        <ul>
          <li><code>OPTIMIZER_CHOOSES</code></li>
          <li><code>BROADCAST_HASH_SECOND</code></li>
          <li><code>REPARTITION_HASH_SECOND</code></li>
          <li><code>REPARTITION_SORT_MERGE</code></li>
        </ul>
      </li>
      <li><code>RightOuterJoin</code> supports:
        <ul>
          <li><code>OPTIMIZER_CHOOSES</code></li>
          <li><code>BROADCAST_HASH_FIRST</code></li>
          <li><code>REPARTITION_HASH_FIRST</code></li>
          <li><code>REPARTITION_SORT_MERGE</code></li>
        </ul>
      </li>
      <li><code>FullOuterJoin</code> supports:
        <ul>
          <li><code>OPTIMIZER_CHOOSES</code></li>
          <li><code>REPARTITION_SORT_MERGE</code></li>
        </ul>
      </li>
    </ul>

    <h3 id="cross">Cross</h3>

    <p>交叉转换（Croass）合并2个数据集到一个数据集。 它建立所有的成对的2个数据集元素的combination， 实际上就是创建一个笛卡尔集。
cross转换或者调用一个用户自定义的cross函数在每一对元素上或者输出Tuple2。</p>

    <p><strong>注意：</strong> cross转换是一个<em>非常</em>耗cpu的操作， 它会冲击一个即使很大的集群。</p>

    <h4 id="cross-with-user-defined-function">Cross with User-Defined Function</h4>
    <p>调用用户自定义函数的cross转换。</p>

    <p>cross转换可以调用一个用户自定义的cross函数， 这个cross函数接受2个元素， 其中一个元素来自第一个数据集，第二个元素来自第二个数据集，并返回一个结果元素。</p>

    <p>下例展示调用用户自定义函数的cross转换：</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Coord</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// CrossFunction computes the Euclidean distance between two Coord objects.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EuclideanDistComputer</span>
         <span class="kd">implements</span> <span class="n">CrossFunction</span><span class="o">&lt;</span><span class="n">Coord</span><span class="o">,</span> <span class="n">Coord</span><span class="o">,</span> <span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="nf">cross</span><span class="o">(</span><span class="n">Coord</span> <span class="n">c1</span><span class="o">,</span> <span class="n">Coord</span> <span class="n">c2</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// compute Euclidean distance of coordinates</span>
    <span class="kt">double</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="na">x</span> <span class="o">-</span> <span class="n">c2</span><span class="o">.</span><span class="na">x</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="n">pow</span><span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="na">y</span> <span class="o">-</span> <span class="n">c2</span><span class="o">.</span><span class="na">y</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;(</span><span class="n">c1</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">c2</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">dist</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Coord</span><span class="o">&gt;</span> <span class="n">coords1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Coord</span><span class="o">&gt;</span> <span class="n">coords2</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span>
            <span class="n">distances</span> <span class="o">=</span>
            <span class="n">coords1</span><span class="o">.</span><span class="na">cross</span><span class="o">(</span><span class="n">coords2</span><span class="o">)</span>
                   <span class="c1">// apply CrossFunction</span>
                   <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="nf">EuclideanDistComputer</span><span class="o">());</span></code></pre></div>

        <h4 id="cross-with-projection">Cross with Projection</h4>

        <p>cross转换可以通过投射（projection）来构建结果tuple， 如下所示：</p>

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Byte</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple4</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Byte</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span>
            <span class="n">result</span> <span class="o">=</span>
            <span class="n">input1</span><span class="o">.</span><span class="na">cross</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                  <span class="c1">// select and reorder fields of matching tuples</span>
                  <span class="o">.</span><span class="na">projectSecond</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">projectFirst</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">0</span><span class="o">).</span><span class="na">projectSecond</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span></code></pre></div>

        <p>在一个cross 投射（projection）里面字段选择方式和join projection 是一样的。</p>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">case</span> <span class="k">class</span> <span class="nc">Coord</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="n">coords1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Coord</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">coords2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">Coord</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="k">val</span> <span class="n">distances</span> <span class="k">=</span> <span class="n">coords1</span><span class="o">.</span><span class="n">cross</span><span class="o">(</span><span class="n">coords2</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">c1</span><span class="o">,</span> <span class="n">c2</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">dist</span> <span class="k">=</span> <span class="n">sqrt</span><span class="o">(</span><span class="n">pow</span><span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">c2</span><span class="o">.</span><span class="n">x</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="n">pow</span><span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">c2</span><span class="o">.</span><span class="n">y</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
    <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">dist</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"> <span class="k">class</span> <span class="nc">Euclid</span><span class="p">(</span><span class="n">CrossFunction</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
     <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c2</span><span class="o">.</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">c2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>

 <span class="n">distances</span> <span class="o">=</span> <span class="n">coords1</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">coords2</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">Euclid</span><span class="p">())</span></code></pre></div>

        <h4 id="cross-with-projection-1">Cross with Projection</h4>

        <p>cross转换可以通过投射（projection）来构建结果tuple， 如下所示：</p>

        <div class="highlight"><pre><code class="language-python"><span class="n">result</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span><span class="o">.</span><span class="n">projectFirst</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">projectSecond</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></code></pre></div>

        <p>在一个cross 投射（projection）里面字段选择方式和join projection 是一样的。</p>

      </div>
    </div>

    <h4 id="cross-with-dataset-size-hint">Cross with DataSet Size Hint</h4>

    <p>为了帮助优化器选择正确的执行策略， 可以提示数据集的大小给cross函数， 如下所示：</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">input2</span> <span class="o">=</span> <span class="c1">// [...]</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple4</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span>
            <span class="n">udfResult</span> <span class="o">=</span>
                  <span class="c1">// hint that the second DataSet is very small</span>
            <span class="n">input1</span><span class="o">.</span><span class="na">crossWithTiny</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                  <span class="c1">// apply any Cross function (or projection)</span>
                  <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="nf">MyCrosser</span><span class="o">());</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple3</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span>
            <span class="n">projectResult</span> <span class="o">=</span>
                  <span class="c1">// hint that the second DataSet is very large</span>
            <span class="n">input1</span><span class="o">.</span><span class="na">crossWithHuge</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>
                  <span class="c1">// apply a projection (or any Cross function)</span>
                  <span class="o">.</span><span class="na">projectFirst</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">).</span><span class="na">projectSecond</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">input1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">input2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="c1">// hint that the second DataSet is very small</span>
<span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">crossWithTiny</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span>

<span class="c1">// hint that the second DataSet is very large</span>
<span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">crossWithHuge</span><span class="o">(</span><span class="n">input2</span><span class="o">)</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"> <span class="c">#hint that the second DataSet is very small</span>
 <span class="n">result1</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">cross_with_tiny</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span>

 <span class="c">#hint that the second DataSet is very large</span>
 <span class="n">result1</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">cross_with_huge</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span></code></pre></div>

      </div>
    </div>

    <h3 id="cogroup">CoGroup</h3>

    <p>CoGroup转换共同处理2个数据集的groups。 2个数据集都是在一个定义好的key上进行分组（grouped）。 2个数据集上共享相同key的分组会输入个用户自定义的co-group函数。
如果一个指定的key仅仅在一个数据集上有group， 则输入这个group和一个空group给co－group函数。
co－group函数可以独立在各自group上进行迭代，并返回一个任意大小的result 元素。</p>

    <p>类似Reduce, GroupReduce, and Join， 可以使用不同的key-selection函数来选择key。</p>

    <h4 id="cogroup-on-datasets">CoGroup on DataSets</h4>

    <div class="codetabs">
      <div data-lang="java">

        <p>下例展示通过filed position（仅仅tuple数据集）来做group。 用户可以同哟pojo类型和key表达式做同样事情。</p>

        <div class="highlight"><pre><code class="language-java"><span class="c1">// Some CoGroupFunction definition</span>
<span class="kd">class</span> <span class="nc">MyCoGrouper</span>
         <span class="kd">implements</span> <span class="n">CoGroupFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">coGroup</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">iVals</span><span class="o">,</span>
                      <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">dVals</span><span class="o">,</span>
                      <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ints</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>

    <span class="c1">// add all Integer values in group to set</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">val</span> <span class="o">:</span> <span class="n">iVals</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ints</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">val</span><span class="o">.</span><span class="na">f1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// multiply each Double value with each unique Integer values of group</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">:</span> <span class="n">dVals</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">i</span> <span class="o">:</span> <span class="n">ints</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">val</span><span class="o">.</span><span class="na">f1</span> <span class="o">*</span> <span class="n">i</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">iVals</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">dVals</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">iVals</span><span class="o">.</span><span class="na">coGroup</span><span class="o">(</span><span class="n">dVals</span><span class="o">)</span>
                         <span class="c1">// group first DataSet on first tuple field</span>
                         <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                         <span class="c1">// group second DataSet on first tuple field</span>
                         <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                         <span class="c1">// apply CoGroup function on each pair of groups</span>
                         <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">new</span> <span class="nf">MyCoGrouper</span><span class="o">());</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">iVals</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">dVals</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="n">iVals</span><span class="o">.</span><span class="n">coGroup</span><span class="o">(</span><span class="n">dVals</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">iVals</span><span class="o">,</span> <span class="n">dVals</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">ints</span> <span class="k">=</span> <span class="n">iVals</span> <span class="n">map</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">_2</span> <span class="o">}</span> <span class="n">toSet</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">dVal</span> <span class="k">&lt;-</span> <span class="n">dVals</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="n">ints</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">dVal</span><span class="o">.</span><span class="n">_2</span> <span class="o">*</span> <span class="n">i</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"> <span class="k">class</span> <span class="nc">CoGroup</span><span class="p">(</span><span class="n">CoGroupFunction</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">co_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ivals</span><span class="p">,</span> <span class="n">dvals</span><span class="p">,</span> <span class="n">collector</span><span class="p">):</span>
     <span class="n">ints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
     <span class="c"># add all Integer values in group to set</span>
     <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ivals</span><span class="p">:</span>
       <span class="n">ints</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
     <span class="c"># multiply each Double value with each unique Integer values of group</span>
     <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dvals</span><span class="p">:</span>
       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
         <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>


 <span class="n">output</span> <span class="o">=</span> <span class="n">ivals</span><span class="o">.</span><span class="n">co_group</span><span class="p">(</span><span class="n">dvals</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">CoGroup</span><span class="p">())</span></code></pre></div>

      </div>
    </div>

    <h3 id="union">Union</h3>

    <p>执行2个数据集上的union， 这2个数据集必须类型相同。 超过2个的数据集union可以调用union函数多次， 如下所示：</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">vals1</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">vals2</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">vals3</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">unioned</span> <span class="o">=</span> <span class="n">vals1</span><span class="o">.</span><span class="na">union</span><span class="o">(</span><span class="n">vals2</span><span class="o">).</span><span class="na">union</span><span class="o">(</span><span class="n">vals3</span><span class="o">);</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">vals1</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">vals2</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="k">val</span> <span class="n">vals3</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>

<span class="k">val</span> <span class="n">unioned</span> <span class="k">=</span> <span class="n">vals1</span><span class="o">.</span><span class="n">union</span><span class="o">(</span><span class="n">vals2</span><span class="o">).</span><span class="n">union</span><span class="o">(</span><span class="n">vals3</span><span class="o">)</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"> <span class="n">unioned</span> <span class="o">=</span> <span class="n">vals1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">vals3</span><span class="p">)</span></code></pre></div>

      </div>
    </div>

    <h3 id="rebalance">Rebalance</h3>
    <p>均匀rebalance一个多分区的数据集科研用来解决数据倾斜。</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// rebalance DataSet and apply a Map transformation.</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">rebalance</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">new</span> <span class="nf">Mapper</span><span class="o">());</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// rebalance DataSet and apply a Map transformation.</span>
<span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">rebalance</span><span class="o">().</span><span class="n">map</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

      </div>
    </div>

    <h3 id="hash-partition">Hash-Partition</h3>

    <p>在一个给定key上对一个数据集进行hash-partition.
可以用position key， key表达式， key－selector函数来选择key（查看<a href="#reduce-on-grouped-dataset">Reduce examples</a>）。</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// hash-partition DataSet by String value and apply a MapPartition transformation.</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">partitionByHash</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">mapPartition</span><span class="o">(</span><span class="k">new</span> <span class="nf">PartitionMapper</span><span class="o">());</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// hash-partition DataSet by String value and apply a MapPartition transformation.</span>
<span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">partitionByHash</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">mapPartition</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

      </div>
    </div>

    <h3 id="range-partition">Range-Partition</h3>

    <p>在一个给定key上对一个数据集进行range-partition.
可以用position key， key表达式， key－selector函数来选择key（查看<a href="#reduce-on-grouped-dataset">Reduce examples</a>）。</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// range-partition DataSet by String value and apply a MapPartition transformation.</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">partitionByRange</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">mapPartition</span><span class="o">(</span><span class="k">new</span> <span class="nf">PartitionMapper</span><span class="o">());</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// range-partition DataSet by String value and apply a MapPartition transformation.</span>
<span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">partitionByRange</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">mapPartition</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

      </div>
    </div>

    <h3 id="sort-partition">Sort Partition</h3>

    <p>基于一个指定的字段按照指定的顺序本地sort一个数据集的所有分区。
可以用position key， key表达式， key－selector函数来选择key（查看<a href="#reduce-on-grouped-dataset">Reduce examples</a>）。
可以通过链接<code>sortPartition()</code>来基于多个字段进行parition 排序。</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// Locally sort partitions in ascending order on the second String field and</span>
<span class="c1">// in descending order on the first String field.</span>
<span class="c1">// Apply a MapPartition transformation on the sorted partitions.</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">sortPartition</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Order</span><span class="o">.</span><span class="na">ASCENDING</span><span class="o">)</span>
                                          <span class="o">.</span><span class="na">sortPartition</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Order</span><span class="o">.</span><span class="na">DESCENDING</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">mapPartition</span><span class="o">(</span><span class="k">new</span> <span class="nf">PartitionMapper</span><span class="o">());</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// Locally sort partitions in ascending order on the second String field and</span>
<span class="c1">// in descending order on the first String field.</span>
<span class="c1">// Apply a MapPartition transformation on the sorted partitions.</span>
<span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">sortPartition</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Order</span><span class="o">.</span><span class="nc">ASCENDING</span><span class="o">)</span>
              <span class="o">.</span><span class="n">sortPartition</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Order</span><span class="o">.</span><span class="nc">DESCENDING</span><span class="o">)</span>
            <span class="o">.</span><span class="n">mapPartition</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></div>

      </div>
    </div>

    <h3 id="first-n">First-n</h3>

    <p>返回一个数据集的签名n 个元素。 first－n可以对一个常见数据集或grouped数据集或grouped 排序的数据集操作。 
可以用position key， key表达式， key－selector函数来选择key（查看<a href="#reduce-on-grouped-dataset">Reduce examples</a>）。</p>

    <div class="codetabs">
      <div data-lang="java">

        <div class="highlight"><pre><code class="language-java"><span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="c1">// [...]</span>
<span class="c1">// Return the first five (arbitrary) elements of the DataSet</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out1</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

<span class="c1">// Return the first two (arbitrary) elements of each String group</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out2</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                          <span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

<span class="c1">// Return the first three elements of each String group ordered by the Integer field</span>
<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out3</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                          <span class="o">.</span><span class="na">sortGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Order</span><span class="o">.</span><span class="na">ASCENDING</span><span class="o">)</span>
                                          <span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span></code></pre></div>

      </div>
      <div data-lang="scala">

        <div class="highlight"><pre><code class="language-scala"><span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="c1">// [...]</span>
<span class="c1">// Return the first five (arbitrary) elements of the DataSet</span>
<span class="k">val</span> <span class="n">out1</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">first</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>

<span class="c1">// Return the first two (arbitrary) elements of each String group</span>
<span class="k">val</span> <span class="n">out2</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">first</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="c1">// Return the first three elements of each String group ordered by the Integer field</span>
<span class="k">val</span> <span class="n">out3</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">sortGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Order</span><span class="o">.</span><span class="nc">ASCENDING</span><span class="o">).</span><span class="n">first</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span></code></pre></div>

      </div>
      <div data-lang="python">

        <div class="highlight"><pre><code class="language-python"><span class="n">Not</span> <span class="n">supported</span><span class="o">.</span></code></pre></div>

      </div>
    </div>
  </div>
</div>

      <div class="footer">
      发现错误？想参与编辑？
      <a href="https://github.com/flink-china/flink-china-doc/edit/1.1.0/apis/batch/dataset_transformations.md" target="_blank">
        在 Github 上编辑此页！
      </a>
    </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/1.1.0/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
